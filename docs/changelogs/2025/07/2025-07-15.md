# 2025-07-15 变更日志

## 系统优化和Bug修复

### 1. 项目结构修复
**问题**: 主目录包含错误的依赖管理文件
- 删除了主目录下的错误 `package.json`、`pnpm-lock.yaml` 和 `node_modules`
- 确保所有前端依赖都在 `frontend/` 目录下正确管理
- 重新安装依赖，解决了 Pinia 状态管理依赖问题

### 2. 认证状态持久化修复
**问题**: 页面刷新后自动退出登录
- 修改 `initializeAuth` 方法，在开发模式下跳过API验证
- 更新请求拦截器，开发模式下不自动清除token
- 增强开发模式的控制台日志，便于调试

### 3. 构建错误修复
**问题**: 缺少组件导致构建失败
- 创建了完整的 `UserForm.vue` 组件，支持用户CRUD操作
- 修复了 `Teacher.vue` 中对不存在组件的引用

### 4. 管理员权限系统修复
**问题**: 管理员导航栏只显示"控制面板"
- 增强 `dev.ts` 中的 `mockLogin` 函数，返回完整的权限数据
- 修复权限系统中的通配符支持（`resource:*`）
- 确保管理员能访问所有功能模块

### 5. 用户管理和教师管理整合
**问题**: 教师管理和用户管理功能重复
- 删除独立的 `Teacher.vue` 页面，避免功能重复
- 重新设计 `User.vue` 页面，采用分页签方式组织用户管理
- 新增分页签：全部用户、管理员、教师、学生
- 增强 `UserForm.vue` 组件，支持教师角色的特殊字段：
  - 工号（teacherId）
  - 学科（subject）
  - 学历（education）
  - 职称（title）
- 更新路由配置，移除教师管理路由
- 优化用户界面，根据不同分页签显示相应的列和操作

### 6. 表单验证增强
- 为教师工号添加格式验证（T+3-6位数字）
- 添加学科选择验证
- 根据角色动态调整表单验证规则

### 7. Vue 3 组件属性修复
**问题**: 弹窗组件的 v-model 绑定错误
- 修复 `UserProfileModal.vue` 中的 `v-model:open="visible"` 问题
- 修复 `AccountSettingsModal.vue` 中的 `v-model:open="visible"` 问题  
- 修复 `ChangePasswordModal.vue` 中的 `v-model:open="visible"` 问题
- 将 `v-model:open="visible"` 改为 `:open="visible"` 和 `@update:open` 事件监听器
- 确保弹窗组件能够正确接收 prop 并触发事件

## 技术改进

### 用户管理页面重构
- 采用分页签设计，统一管理所有用户类型
- 智能搜索：支持按姓名、手机号、工号搜索
- 角色特定显示：教师分页签显示工号和学科，其他分页签显示手机号
- 统计卡片：显示各类用户数量统计
- 批量操作：支持导出、状态切换、密码重置等

### 组件复用优化
- `UserForm.vue` 支持多角色用户创建和编辑
- 根据角色动态显示相应字段
- 智能表单验证和数据提交

## 文件变更

### 删除的文件
- `frontend/src/views/Teacher.vue` - 整合到用户管理中

### 修改的文件
- `frontend/src/views/User.vue` - 重构为分页签式用户管理
- `frontend/src/components/UserForm.vue` - 增强支持教师角色字段
- `frontend/src/router/index.ts` - 移除教师管理路由
- `frontend/src/utils/dev.ts` - 修复权限数据返回

### 新增功能
- 统一的用户管理界面
- 角色特定的表单字段
- 智能搜索和过滤
- 用户统计展示

### 7. 导航栏清理
**问题**: 删除教师管理页面后，导航栏仍显示教师管理菜单项
- 从 `BaseLayout.vue` 中移除教师管理菜单项配置
- 确保导航栏只显示有效的功能模块
- 验证构建成功，无错误提示

## 用户界面完善（2025-07-15 下午更新）

### 8. 用户个人中心功能完善
**问题**: 用户头像下拉菜单功能不完整
- 创建了 `UserProfileModal.vue` 组件，支持个人资料查看和编辑
- 创建了 `AccountSettingsModal.vue` 组件，提供账户设置功能：
  - 基本设置：语言、时区、主题、自动登录
  - 通知设置：系统通知、邮件通知、短信通知、桌面通知
  - 隐私设置：个人信息可见性、活动记录、数据统计
  - 高级设置：开发者模式、实验性功能、缓存管理、数据导出
- 创建了 `ChangePasswordModal.vue` 组件，支持密码修改功能：
  - 密码强度实时检测
  - 密码安全要求提示
  - 修改后自动退出重新登录
- 集成所有弹窗组件到 `BaseLayout.vue` 中

### 9. 独立报名登记页面
**问题**: 用户反馈报名功能需要独立页面
- 创建了独立的 `Registration.vue` 报名登记页面
- 采用分步骤表单设计，包含三个步骤：
  1. 基本信息：姓名、性别、出生日期、民族、文化程度、政治面貌、身份证号、健康状况
  2. 学籍信息：是否在职、保险类别、所报专业、保险有效期、学员证号、超龄协议
  3. 联系信息：家庭住址、联系电话、紧急联系人、个人照片、备注
- 添加进度指示器，显示当前步骤和完成状态
- 支持照片上传功能
- 添加表单验证和身份证号重复检查
- 增加路由配置 `/registration`
- 在侧边栏菜单中添加"报名登记"导航项

### 10. 用户体验优化
- 所有弹窗组件采用现代化设计，圆角边框和阴影效果
- 报名页面采用渐变背景和步骤动画
- 密码修改组件增加密码强度可视化指标
- 账户设置提供丰富的配置选项和说明文字
- 表单验证提供友好的错误提示

## 文件变更

### 新增的文件
- `frontend/src/components/UserProfileModal.vue` - 个人资料弹窗
- `frontend/src/components/AccountSettingsModal.vue` - 账户设置弹窗
- `frontend/src/components/ChangePasswordModal.vue` - 修改密码弹窗
- `frontend/src/views/Registration.vue` - 独立报名登记页面

### 修改的文件
- `frontend/src/components/BaseLayout.vue` - 集成弹窗组件，增加报名登记菜单
- `frontend/src/router/index.ts` - 添加报名登记路由

### 新增功能
- 完整的用户个人中心功能
- 独立的报名登记页面
- 分步骤表单设计
- 密码强度检测
- 账户设置管理
- 照片上传功能

## 课程管理系统完善（2025-07-15 晚间更新）

### 11. 课程管理系统全面升级
**问题**: 原有课程管理功能简陋，不符合老年大学实际需求
- 根据府谷县老年大学实际课程表重新设计课程管理系统
- 扩展课程数据类型定义，新增：
  - 课程分类：音乐类、器乐类、艺术类、文学类、实用技能、综合类
  - 课程级别：一年级、二年级、三年级、基础班、提高班、高级班
  - 时间段管理：支持多个上课时间，包含星期、时段、具体时间
  - 学期管理：2024秋季学期课程安排

### 12. 多视图课程管理界面
**新增功能**:
- **课程表视图**: 以表格形式展示每周课程安排，类似传统课程表
  - 按时间段（上午8:30-10:30，下午3:00-5:00）和星期显示
  - 课程卡片显示课程名称、教师、分类、报名情况
  - 支持按课程分类筛选显示
  - 点击课程卡片查看详细信息
- **课程列表视图**: 传统表格形式管理课程
  - 显示课程信息、分类、级别、教师、时间、报名情况、状态
  - 支持多维度搜索和筛选（分类、状态、级别）
  - 报名进度可视化显示
  - 完整的课程操作功能
- **统计分析视图**: 课程数据统计分析
  - 分类统计：各类课程数量和报名情况
  - 教师工作量统计：每位教师的课程数和学员数
  - 可视化图表展示数据分布

### 13. 实际课程数据集成
**根据课程表录入的课程**:
- **音乐类**: 二人台、声乐一年级、声乐三年级
- **器乐类**: 葫芦丝三年级、古筝二年级、电子琴一年级
- **艺术类**: 书法创作班、绘画基础三年级
- **文学类**: 朗诵与主持基础二年级、诗词鉴赏与写作
- **实用技能**: 计算机应用
- **综合类**: 老干部合唱团

每门课程包含完整信息：教师、容量、已报名人数、上课时间、地点、费用等

### 14. 课程详情弹窗
**新增功能**:
- 点击课程可查看详细信息弹窗
- 显示课程基本信息、报名统计、时间安排
- 可视化展示报名率、剩余名额等关键数据
- 支持从课程表视图和列表视图访问

## 技术改进

### 类型系统完善
- 扩展 `frontend/src/types/index.ts` 中的课程相关类型
- 新增 `CourseCategory`、`CourseLevel`、`TimeSlot` 类型
- 支持复杂的时间段管理和课程分类

### 组件化设计
- 创建独立的课程表展示组件 `CourseScheduleView.vue`
- 模块化的课程管理功能，支持多种视图切换
- 响应式设计，适配不同屏幕尺寸

## 文件变更

### 重新创建的文件
- `frontend/src/views/Course.vue` - 完全重写的课程管理页面

### 新增的文件
- `frontend/src/components/CourseScheduleView.vue` - 课程表视图组件

### 修改的文件
- `frontend/src/types/index.ts` - 扩展课程相关类型定义

### 新增功能
- 三种视图模式的课程管理
- 实际课程数据集成
- 课程表网格展示
- 分类和级别管理
- 统计分析功能
- 课程详情弹窗

## 下一步计划
- 优化用户管理的分页功能
- 添加用户批量操作功能
- 完善教师特殊字段的业务逻辑
- 考虑添加用户导入导出功能 
- 完善报名审核流程
- 优化移动端适配
- 添加课程编辑和新增功能 ✅
- 实现课程冲突检测
- 完善课程报名功能集成

## 课程管理功能实现（2025-07-15 深夜更新）

### 15. 课程管理按钮功能实现
**问题**: 课程管理页面按钮只有UI展示，没有实际功能
- 创建了完整的 `CourseForm.vue` 组件，支持课程的创建和编辑
- 实现了所有操作按钮的实际功能：
  - **添加课程**: 弹出表单对话框，支持完整的课程信息录入
  - **编辑课程**: 点击编辑按钮可修改现有课程信息
  - **删除课程**: 带确认对话框的安全删除功能
  - **批量导入**: 预留功能入口（开发中提示）
  - **导出课表**: 实际可用的CSV格式导出功能
  - **学员名单**: 预留功能入口（开发中提示）

### 16. 课程表单组件功能
**新增的 CourseForm.vue 组件特性**:
- **分步骤布局**: 基本信息、详细信息、时间安排、课程描述
- **智能时间管理**: 支持多个上课时间段，可动态添加/删除
- **完整表单验证**: 所有必填字段的前端验证
- **数据格式化**: 自动处理时间格式、日期格式等
- **编辑模式支持**: 自动填充现有课程数据进行编辑

### 17. 数据导出功能
**CSV导出特性**:
- 包含所有课程的完整信息
- 支持中文字符（UTF-8 BOM）
- 自动生成文件名（包含日期）
- 浏览器直接下载，无需服务器支持

### 18. 用户交互优化
- 操作确认对话框（删除课程）
- 成功/失败消息提示
- 加载状态显示
- 表单重置和取消功能

## 文件变更

### 新增的文件
- `frontend/src/components/CourseForm.vue` - 课程表单组件

### 修改的文件
- `frontend/src/views/Course.vue` - 添加按钮功能实现和表单集成

### 新增功能
- 完整的课程CRUD操作
- 课程表单验证和提交
- CSV格式数据导出
- 用户友好的交互反馈
- 多时间段课程安排

## 课程年龄限制功能（2025-07-15 深夜补充）

### 19. 课程年龄限制系统
**需求背景**: 老年大学不同课程对学员年龄有不同要求，如舞蹈课需要一定体力
- **新增年龄限制类型**: 在Course接口中添加AgeRestriction类型定义
  - enabled: 是否启用年龄限制
  - minAge: 最小年龄限制（可选）
  - maxAge: 最大年龄限制（可选）
  - description: 年龄限制说明

### 20. CourseForm表单增强
**年龄限制设置区域**:
- 添加启用/禁用年龄限制的开关控件
- 支持设置最小和最大年龄输入框
- 添加年龄限制说明文本框
- 提供快速设置模板按钮：
  - **65岁以下（舞蹈类）**: 适用于舞蹈、体操等高强度运动课程
  - **70岁以下（体力类）**: 适用于需要一定体力的户外活动课程
  - **50岁以上（养生类）**: 适用于中老年人的养生保健课程
  - **60岁以上（兴趣类）**: 专为退休人员设计的兴趣课程
  - **清除限制**: 一键清除所有年龄限制设置

### 21. 课程展示优化
**年龄限制信息展示**:
- **课程列表视图**: 新增年龄限制列，使用橙色标识有年龄限制的课程
- **课程详情弹窗**: 显示详细的年龄限制信息
- **格式化显示**: 智能格式化年龄限制文本
  - "65岁以下 (舞蹈课程需要一定的身体协调性)"
  - "50岁以上 (适合中老年人的养生保健课程)"
  - "60-70岁 (专为退休人员设计)"

### 22. 示例数据更新
**新增示例课程**:
- **民族舞蹈课程**: 设置65岁以下年龄限制，展示年龄限制功能
- **所有现有课程**: 添加年龄限制字段（默认无限制状态）

### 23. 技术实现
**类型安全和数据处理**:
- 扩展Course接口，添加ageRestriction必填字段
- 创建AgeRestriction接口，支持可选的最小/最大年龄
- 实现formatAgeRestriction格式化函数
- 添加setAgeRestriction和clearAgeRestriction辅助方法

## 文件变更

### 修改的文件
- `frontend/src/types/index.ts` - 添加AgeRestriction类型定义
- `frontend/src/components/CourseForm.vue` - 添加年龄限制表单区域
- `frontend/src/views/Course.vue` - 添加年龄限制显示和格式化

### 新增功能
- 课程年龄限制管理
- 快速设置模板
- 年龄限制信息展示
- 智能格式化显示

**使用场景示例**: 
- 舞蹈课程：建议65岁以下学员报名，避免运动风险
- 体力活动：建议70岁以下学员报名，确保活动安全
- 养生课程：适合50岁以上学员，针对性更强
- 兴趣课程：适合60岁以上退休人员，时间安排更灵活

## 学员签到系统（2025-07-15 深夜开发）

### 24. 基于人脸识别的智能签到系统
**创新功能**: 为老年大学开发现代化的签到管理系统，提高签到效率和准确性
- **签到数据类型定义**: 
  - AttendanceStatus: 签到状态（出席、缺席、迟到、请假）
  - AttendanceMethod: 签到方式（人脸识别、手动、二维码、刷卡）
  - AttendanceRecord: 签到记录完整信息
  - AttendanceSession: 课程签到会话管理
  - FaceRecognitionResult: 人脸识别结果

### 25. 人脸识别组件 (FaceRecognition.vue)
**核心技术特性**:
- **摄像头控制**: 启动/停止摄像头，支持前置摄像头
- **实时人脸检测**: 检测人脸位置，显示识别框
- **拍照识别**: 高质量照片采集和人脸识别处理
- **识别结果展示**: 显示学员信息、置信度和识别状态
- **用户引导**: 提供清晰的操作指导和状态反馈

**技术实现**:
- 使用MediaDevices API访问摄像头
- Canvas绘制和图像处理
- 模拟人脸检测算法（可集成真实AI服务）
- 响应式UI设计，适配不同设备

### 26. 签到管理页面 (Attendance.vue)
**功能模块**:
- **签到会话管理**: 创建、选择和管理课程签到会话
- **人脸识别签到**: 集成人脸识别组件，自动识别学员
- **手动签到**: 支持手动选择学员和签到状态
- **实时统计**: 显示签到率、出席情况等关键数据
- **签到记录**: 实时展示签到记录和详细信息

**界面设计**:
- **会话卡片**: 直观显示课程信息和签到进度
- **统计面板**: 可视化展示签到数据
- **操作区域**: 人脸识别和手动签到并行操作
- **记录列表**: 实时更新的签到记录表格

### 27. 智能签到流程
**签到流程设计**:
1. **创建签到会话**: 选择课程、设置时间和地点
2. **激活签到**: 自动或手动激活签到会话
3. **学员签到**: 
   - 人脸识别：启动摄像头→检测人脸→拍照识别→确认签到
   - 手动录入：选择学员→选择状态→添加备注→确认签到
4. **实时统计**: 自动更新出席率和统计数据
5. **结束会话**: 完成签到，生成最终报告

### 28. 权限和安全控制
**访问控制**:
- 仅管理员和教师可以管理签到
- 基于角色的菜单显示
- 签到数据安全存储和传输

**数据安全**:
- 人脸图像本地处理，不存储敏感数据
- 签到记录完整审计日志
- 权限验证和操作确认

### 29. 用户体验优化
**交互设计**:
- 直观的视觉反馈和状态指示
- 流畅的动画过渡效果
- 响应式布局，适配各种设备
- 友好的错误提示和操作指导

**性能优化**:
- 摄像头资源管理
- 实时数据更新
- 组件懒加载

## 文件变更

### 新增的文件
- `frontend/src/components/FaceRecognition.vue` - 人脸识别组件
- `frontend/src/views/Attendance.vue` - 签到管理页面

### 修改的文件
- `frontend/src/types/index.ts` - 添加签到相关类型定义
- `frontend/src/router/index.ts` - 添加签到管理路由
- `frontend/src/components/BaseLayout.vue` - 添加签到管理菜单

### 新增功能
- 完整的人脸识别签到系统
- 签到会话管理
- 实时签到统计和记录
- 多种签到方式支持
- 智能化的用户交互

**技术栈**:
- Vue 3 Composition API
- TypeScript 类型安全
- Ant Design Vue UI组件
- MediaDevices API 摄像头控制
- Canvas 图像处理
- 响应式设计

### 30. 教师权限修复
**问题修复**: 教师用户无法看到学员签到菜单
- **权限配置更新**: 为教师角色添加 `attendance:manage` 权限
- **菜单显示**: 确保教师用户可以访问学员签到功能
- **权限验证**: 验证权限检查逻辑正确性

**修复内容**:
- 在 `dev.ts` 中为教师角色添加签到管理权限
- 确保菜单过滤逻辑正确应用权限检查
- 教师现在可以完整使用签到系统功能

## 文件变更

### 修改的文件
- `frontend/src/utils/dev.ts` - 为教师角色添加attendance:manage权限

### 权限更新
- **管理员**: 拥有所有权限（包括签到管理）
- **教师**: 新增签到管理权限，可以完整使用签到系统
- **学生**: 无签到管理权限（符合业务逻辑） 