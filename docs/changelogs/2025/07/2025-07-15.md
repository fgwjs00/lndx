# 2025-07-15 变更日志

## 系统优化和Bug修复

### 1. 项目结构修复
**问题**: 主目录包含错误的依赖管理文件
- 删除了主目录下的错误 `package.json`、`pnpm-lock.yaml` 和 `node_modules`
- 确保所有前端依赖都在 `frontend/` 目录下正确管理
- 重新安装依赖，解决了 Pinia 状态管理依赖问题

### 2. 认证状态持久化修复
**问题**: 页面刷新后自动退出登录
- 修改 `initializeAuth` 方法，在开发模式下跳过API验证
- 更新请求拦截器，开发模式下不自动清除token
- 增强开发模式的控制台日志，便于调试

### 3. 构建错误修复
**问题**: 缺少组件导致构建失败
- 创建了完整的 `UserForm.vue` 组件，支持用户CRUD操作
- 修复了 `Teacher.vue` 中对不存在组件的引用

### 4. 管理员权限系统修复
**问题**: 管理员导航栏只显示"控制面板"
- 增强 `dev.ts` 中的 `mockLogin` 函数，返回完整的权限数据
- 修复权限系统中的通配符支持（`resource:*`）
- 确保管理员能访问所有功能模块

### 5. 用户管理和教师管理整合
**问题**: 教师管理和用户管理功能重复
- 删除独立的 `Teacher.vue` 页面，避免功能重复
- 重新设计 `User.vue` 页面，采用分页签方式组织用户管理
- 新增分页签：全部用户、管理员、教师、学生
- 增强 `UserForm.vue` 组件，支持教师角色的特殊字段：
  - 工号（teacherId）
  - 学科（subject）
  - 学历（education）
  - 职称（title）
- 更新路由配置，移除教师管理路由
- 优化用户界面，根据不同分页签显示相应的列和操作

### 6. 表单验证增强
- 为教师工号添加格式验证（T+3-6位数字）
- 添加学科选择验证
- 根据角色动态调整表单验证规则

### 7. Vue 3 组件属性修复
**问题**: 弹窗组件的 v-model 绑定错误
- 修复 `UserProfileModal.vue` 中的 `v-model:open="visible"` 问题
- 修复 `AccountSettingsModal.vue` 中的 `v-model:open="visible"` 问题  
- 修复 `ChangePasswordModal.vue` 中的 `v-model:open="visible"` 问题
- 将 `v-model:open="visible"` 改为 `:open="visible"` 和 `@update:open` 事件监听器
- 确保弹窗组件能够正确接收 prop 并触发事件

## 技术改进

### 用户管理页面重构
- 采用分页签设计，统一管理所有用户类型
- 智能搜索：支持按姓名、手机号、工号搜索
- 角色特定显示：教师分页签显示工号和学科，其他分页签显示手机号
- 统计卡片：显示各类用户数量统计
- 批量操作：支持导出、状态切换、密码重置等

### 组件复用优化
- `UserForm.vue` 支持多角色用户创建和编辑
- 根据角色动态显示相应字段
- 智能表单验证和数据提交

## 文件变更

### 删除的文件
- `frontend/src/views/Teacher.vue` - 整合到用户管理中

### 修改的文件
- `frontend/src/views/User.vue` - 重构为分页签式用户管理
- `frontend/src/components/UserForm.vue` - 增强支持教师角色字段
- `frontend/src/router/index.ts` - 移除教师管理路由
- `frontend/src/utils/dev.ts` - 修复权限数据返回

### 新增功能
- 统一的用户管理界面
- 角色特定的表单字段
- 智能搜索和过滤
- 用户统计展示

### 7. 导航栏清理
**问题**: 删除教师管理页面后，导航栏仍显示教师管理菜单项
- 从 `BaseLayout.vue` 中移除教师管理菜单项配置
- 确保导航栏只显示有效的功能模块
- 验证构建成功，无错误提示

## 用户界面完善（2025-07-15 下午更新）

### 8. 用户个人中心功能完善
**问题**: 用户头像下拉菜单功能不完整
- 创建了 `UserProfileModal.vue` 组件，支持个人资料查看和编辑
- 创建了 `AccountSettingsModal.vue` 组件，提供账户设置功能：
  - 基本设置：语言、时区、主题、自动登录
  - 通知设置：系统通知、邮件通知、短信通知、桌面通知
  - 隐私设置：个人信息可见性、活动记录、数据统计
  - 高级设置：开发者模式、实验性功能、缓存管理、数据导出
- 创建了 `ChangePasswordModal.vue` 组件，支持密码修改功能：
  - 密码强度实时检测
  - 密码安全要求提示
  - 修改后自动退出重新登录
- 集成所有弹窗组件到 `BaseLayout.vue` 中

### 9. 独立报名登记页面
**问题**: 用户反馈报名功能需要独立页面
- 创建了独立的 `Registration.vue` 报名登记页面
- 采用分步骤表单设计，包含三个步骤：
  1. 基本信息：姓名、性别、出生日期、民族、文化程度、政治面貌、身份证号、健康状况
  2. 学籍信息：是否在职、保险类别、所报专业、保险有效期、学员证号、超龄协议
  3. 联系信息：家庭住址、联系电话、紧急联系人、个人照片、备注
- 添加进度指示器，显示当前步骤和完成状态
- 支持照片上传功能
- 添加表单验证和身份证号重复检查
- 增加路由配置 `/registration`
- 在侧边栏菜单中添加"报名登记"导航项

### 10. 用户体验优化
- 所有弹窗组件采用现代化设计，圆角边框和阴影效果
- 报名页面采用渐变背景和步骤动画
- 密码修改组件增加密码强度可视化指标
- 账户设置提供丰富的配置选项和说明文字
- 表单验证提供友好的错误提示

## 文件变更

### 新增的文件
- `frontend/src/components/UserProfileModal.vue` - 个人资料弹窗
- `frontend/src/components/AccountSettingsModal.vue` - 账户设置弹窗
- `frontend/src/components/ChangePasswordModal.vue` - 修改密码弹窗
- `frontend/src/views/Registration.vue` - 独立报名登记页面

### 修改的文件
- `frontend/src/components/BaseLayout.vue` - 集成弹窗组件，增加报名登记菜单
- `frontend/src/router/index.ts` - 添加报名登记路由

### 新增功能
- 完整的用户个人中心功能
- 独立的报名登记页面
- 分步骤表单设计
- 密码强度检测
- 账户设置管理
- 照片上传功能

## 课程管理系统完善（2025-07-15 晚间更新）

### 11. 课程管理系统全面升级
**问题**: 原有课程管理功能简陋，不符合老年大学实际需求
- 根据府谷县老年大学实际课程表重新设计课程管理系统
- 扩展课程数据类型定义，新增：
  - 课程分类：音乐类、器乐类、艺术类、文学类、实用技能、综合类
  - 课程级别：一年级、二年级、三年级、基础班、提高班、高级班
  - 时间段管理：支持多个上课时间，包含星期、时段、具体时间
  - 学期管理：2024秋季学期课程安排

### 12. 多视图课程管理界面
**新增功能**:
- **课程表视图**: 以表格形式展示每周课程安排，类似传统课程表
  - 按时间段（上午8:30-10:30，下午3:00-5:00）和星期显示
  - 课程卡片显示课程名称、教师、分类、报名情况
  - 支持按课程分类筛选显示
  - 点击课程卡片查看详细信息
- **课程列表视图**: 传统表格形式管理课程
  - 显示课程信息、分类、级别、教师、时间、报名情况、状态
  - 支持多维度搜索和筛选（分类、状态、级别）
  - 报名进度可视化显示
  - 完整的课程操作功能
- **统计分析视图**: 课程数据统计分析
  - 分类统计：各类课程数量和报名情况
  - 教师工作量统计：每位教师的课程数和学员数
  - 可视化图表展示数据分布

### 13. 实际课程数据集成
**根据课程表录入的课程**:
- **音乐类**: 二人台、声乐一年级、声乐三年级
- **器乐类**: 葫芦丝三年级、古筝二年级、电子琴一年级
- **艺术类**: 书法创作班、绘画基础三年级
- **文学类**: 朗诵与主持基础二年级、诗词鉴赏与写作
- **实用技能**: 计算机应用
- **综合类**: 老干部合唱团

每门课程包含完整信息：教师、容量、已报名人数、上课时间、地点、费用等

### 14. 课程详情弹窗
**新增功能**:
- 点击课程可查看详细信息弹窗
- 显示课程基本信息、报名统计、时间安排
- 可视化展示报名率、剩余名额等关键数据
- 支持从课程表视图和列表视图访问

## 技术改进

### 类型系统完善
- 扩展 `frontend/src/types/index.ts` 中的课程相关类型
- 新增 `CourseCategory`、`CourseLevel`、`TimeSlot` 类型
- 支持复杂的时间段管理和课程分类

### 组件化设计
- 创建独立的课程表展示组件 `CourseScheduleView.vue`
- 模块化的课程管理功能，支持多种视图切换
- 响应式设计，适配不同屏幕尺寸

## 文件变更

### 重新创建的文件
- `frontend/src/views/Course.vue` - 完全重写的课程管理页面

### 新增的文件
- `frontend/src/components/CourseScheduleView.vue` - 课程表视图组件

### 修改的文件
- `frontend/src/types/index.ts` - 扩展课程相关类型定义

### 新增功能
- 三种视图模式的课程管理
- 实际课程数据集成
- 课程表网格展示
- 分类和级别管理
- 统计分析功能
- 课程详情弹窗

## 下一步计划
- 优化用户管理的分页功能
- 添加用户批量操作功能
- 完善教师特殊字段的业务逻辑
- 考虑添加用户导入导出功能 
- 完善报名审核流程
- 优化移动端适配
- 添加课程编辑和新增功能 ✅
- 实现课程冲突检测
- 完善课程报名功能集成

## 课程管理功能实现（2025-07-15 深夜更新）

### 15. 课程管理按钮功能实现
**问题**: 课程管理页面按钮只有UI展示，没有实际功能
- 创建了完整的 `CourseForm.vue` 组件，支持课程的创建和编辑
- 实现了所有操作按钮的实际功能：
  - **添加课程**: 弹出表单对话框，支持完整的课程信息录入
  - **编辑课程**: 点击编辑按钮可修改现有课程信息
  - **删除课程**: 带确认对话框的安全删除功能
  - **批量导入**: 预留功能入口（开发中提示）
  - **导出课表**: 实际可用的CSV格式导出功能
  - **学员名单**: 预留功能入口（开发中提示）

### 16. 课程表单组件功能
**新增的 CourseForm.vue 组件特性**:
- **分步骤布局**: 基本信息、详细信息、时间安排、课程描述
- **智能时间管理**: 支持多个上课时间段，可动态添加/删除
- **完整表单验证**: 所有必填字段的前端验证
- **数据格式化**: 自动处理时间格式、日期格式等
- **编辑模式支持**: 自动填充现有课程数据进行编辑

### 17. 数据导出功能
**CSV导出特性**:
- 包含所有课程的完整信息
- 支持中文字符（UTF-8 BOM）
- 自动生成文件名（包含日期）
- 浏览器直接下载，无需服务器支持

### 18. 用户交互优化
- 操作确认对话框（删除课程）
- 成功/失败消息提示
- 加载状态显示
- 表单重置和取消功能

## 文件变更

### 新增的文件
- `frontend/src/components/CourseForm.vue` - 课程表单组件

### 修改的文件
- `frontend/src/views/Course.vue` - 添加按钮功能实现和表单集成

### 新增功能
- 完整的课程CRUD操作
- 课程表单验证和提交
- CSV格式数据导出
- 用户友好的交互反馈
- 多时间段课程安排

## 课程年龄限制功能（2025-07-15 深夜补充）

### 19. 课程年龄限制系统
**需求背景**: 老年大学不同课程对学员年龄有不同要求，如舞蹈课需要一定体力
- **新增年龄限制类型**: 在Course接口中添加AgeRestriction类型定义
  - enabled: 是否启用年龄限制
  - minAge: 最小年龄限制（可选）
  - maxAge: 最大年龄限制（可选）
  - description: 年龄限制说明

### 20. CourseForm表单增强
**年龄限制设置区域**:
- 添加启用/禁用年龄限制的开关控件
- 支持设置最小和最大年龄输入框
- 添加年龄限制说明文本框
- 提供快速设置模板按钮：
  - **65岁以下（舞蹈类）**: 适用于舞蹈、体操等高强度运动课程
  - **70岁以下（体力类）**: 适用于需要一定体力的户外活动课程
  - **50岁以上（养生类）**: 适用于中老年人的养生保健课程
  - **60岁以上（兴趣类）**: 专为退休人员设计的兴趣课程
  - **清除限制**: 一键清除所有年龄限制设置

### 21. 课程展示优化
**年龄限制信息展示**:
- **课程列表视图**: 新增年龄限制列，使用橙色标识有年龄限制的课程
- **课程详情弹窗**: 显示详细的年龄限制信息
- **格式化显示**: 智能格式化年龄限制文本
  - "65岁以下 (舞蹈课程需要一定的身体协调性)"
  - "50岁以上 (适合中老年人的养生保健课程)"
  - "60-70岁 (专为退休人员设计)"

### 22. 示例数据更新
**新增示例课程**:
- **民族舞蹈课程**: 设置65岁以下年龄限制，展示年龄限制功能
- **所有现有课程**: 添加年龄限制字段（默认无限制状态）

### 23. 技术实现
**类型安全和数据处理**:
- 扩展Course接口，添加ageRestriction必填字段
- 创建AgeRestriction接口，支持可选的最小/最大年龄
- 实现formatAgeRestriction格式化函数
- 添加setAgeRestriction和clearAgeRestriction辅助方法

## 文件变更

### 修改的文件
- `frontend/src/types/index.ts` - 添加AgeRestriction类型定义
- `frontend/src/components/CourseForm.vue` - 添加年龄限制表单区域
- `frontend/src/views/Course.vue` - 添加年龄限制显示和格式化

### 新增功能
- 课程年龄限制管理
- 快速设置模板
- 年龄限制信息展示
- 智能格式化显示

**使用场景示例**: 
- 舞蹈课程：建议65岁以下学员报名，避免运动风险
- 体力活动：建议70岁以下学员报名，确保活动安全
- 养生课程：适合50岁以上学员，针对性更强
- 兴趣课程：适合60岁以上退休人员，时间安排更灵活

## 学员签到系统（2025-07-15 深夜开发）

### 24. 基于人脸识别的智能签到系统
**创新功能**: 为老年大学开发现代化的签到管理系统，提高签到效率和准确性
- **签到数据类型定义**: 
  - AttendanceStatus: 签到状态（出席、缺席、迟到、请假）
  - AttendanceMethod: 签到方式（人脸识别、手动、二维码、刷卡）
  - AttendanceRecord: 签到记录完整信息
  - AttendanceSession: 课程签到会话管理
  - FaceRecognitionResult: 人脸识别结果

### 25. 人脸识别组件 (FaceRecognition.vue)
**核心技术特性**:
- **摄像头控制**: 启动/停止摄像头，支持前置摄像头
- **实时人脸检测**: 检测人脸位置，显示识别框
- **拍照识别**: 高质量照片采集和人脸识别处理
- **识别结果展示**: 显示学员信息、置信度和识别状态
- **用户引导**: 提供清晰的操作指导和状态反馈

**技术实现**:
- 使用MediaDevices API访问摄像头
- Canvas绘制和图像处理
- 模拟人脸检测算法（可集成真实AI服务）
- 响应式UI设计，适配不同设备

### 26. 签到管理页面 (Attendance.vue)
**功能模块**:
- **签到会话管理**: 创建、选择和管理课程签到会话
- **人脸识别签到**: 集成人脸识别组件，自动识别学员
- **手动签到**: 支持手动选择学员和签到状态
- **实时统计**: 显示签到率、出席情况等关键数据
- **签到记录**: 实时展示签到记录和详细信息

**界面设计**:
- **会话卡片**: 直观显示课程信息和签到进度
- **统计面板**: 可视化展示签到数据
- **操作区域**: 人脸识别和手动签到并行操作
- **记录列表**: 实时更新的签到记录表格

### 27. 智能签到流程
**签到流程设计**:
1. **创建签到会话**: 选择课程、设置时间和地点
2. **激活签到**: 自动或手动激活签到会话
3. **学员签到**: 
   - 人脸识别：启动摄像头→检测人脸→拍照识别→确认签到
   - 手动录入：选择学员→选择状态→添加备注→确认签到
4. **实时统计**: 自动更新出席率和统计数据
5. **结束会话**: 完成签到，生成最终报告

### 28. 权限和安全控制
**访问控制**:
- 仅管理员和教师可以管理签到
- 基于角色的菜单显示
- 签到数据安全存储和传输

**数据安全**:
- 人脸图像本地处理，不存储敏感数据
- 签到记录完整审计日志
- 权限验证和操作确认

### 29. 用户体验优化
**交互设计**:
- 直观的视觉反馈和状态指示
- 流畅的动画过渡效果
- 响应式布局，适配各种设备
- 友好的错误提示和操作指导

**性能优化**:
- 摄像头资源管理
- 实时数据更新
- 组件懒加载

## 文件变更

### 新增的文件
- `frontend/src/components/FaceRecognition.vue` - 人脸识别组件
- `frontend/src/views/Attendance.vue` - 签到管理页面

### 修改的文件
- `frontend/src/types/index.ts` - 添加签到相关类型定义
- `frontend/src/router/index.ts` - 添加签到管理路由
- `frontend/src/components/BaseLayout.vue` - 添加签到管理菜单

### 新增功能
- 完整的人脸识别签到系统
- 签到会话管理
- 实时签到统计和记录
- 多种签到方式支持
- 智能化的用户交互

**技术栈**:
- Vue 3 Composition API
- TypeScript 类型安全
- Ant Design Vue UI组件
- MediaDevices API 摄像头控制
- Canvas 图像处理
- 响应式设计

### 30. 教师权限修复
**问题修复**: 教师用户无法看到学员签到菜单
- **权限配置更新**: 为教师角色添加 `attendance:manage` 权限
- **菜单显示**: 确保教师用户可以访问学员签到功能
- **权限验证**: 验证权限检查逻辑正确性

**修复内容**:
- 在 `dev.ts` 中为教师角色添加签到管理权限
- 确保菜单过滤逻辑正确应用权限检查
- 教师现在可以完整使用签到系统功能

## 文件变更

### 修改的文件
- `frontend/src/utils/dev.ts` - 为教师角色添加attendance:manage权限

### 权限更新
- **管理员**: 拥有所有权限（包括签到管理）
- **教师**: 新增签到管理权限，可以完整使用签到系统
- **学生**: 无签到管理权限（符合业务逻辑）

### 31. 生产环境API问题修复
**问题**: 生产环境部署后出现API请求错误，返回HTML而非JSON
- **错误信息**: `POST http://ln.tuojiayi.com/api/auth/login 405 (Not Allowed)`
- **根本原因**: 生产环境没有后端API服务，前端尝试请求真实API导致错误

**修复方案**:
- **配置更新**: 修改 `vite.config.ts`，让生产环境也使用模拟认证
- **请求拦截**: 在 `request.ts` 中添加模拟请求处理逻辑
- **API模拟**: 支持登录、短信验证等核心API的模拟响应

**技术实现**:
```typescript
// vite.config.ts - 生产环境启用模拟
__SKIP_CAPTCHA__: JSON.stringify(true),
__MOCK_AUTH__: JSON.stringify(true)

// request.ts - 模拟请求处理
private async handleMockRequest<T>(config: RequestConfig): Promise<ApiResponse<T>> {
  if (config.url === '/auth/login') {
    return mockLogin(phone, password)
  }
  // ... 其他API模拟
}
```

**解决效果**:
- ✅ 生产环境可正常登录和使用所有功能
- ✅ 客户可以完整体验系统功能
- ✅ 无需部署后端服务即可进行前端测试
- ✅ 保持开发和生产环境的一致性

## 文件变更

### 修改的文件
- `frontend/vite.config.ts` - 生产环境启用模拟模式
- `frontend/src/api/request.ts` - 添加模拟请求处理逻辑

### 部署说明
- 现在可以将 `frontend/dist/` 目录直接部署到静态文件服务器
- 无需配置后端API，系统将自动使用模拟数据
- 客户可以使用测试账号完整体验所有功能

### 32. 报名表单字段优化
**优化内容**: 调整报名登记页面的字段布局和命名

**基本信息新增字段**:
- ✅ **身份证地址**: 新增必填字段，支持多行输入（最多100字符）
- ✅ **联系电话**: 新增必填字段，支持11位手机号格式验证

**联系信息调整**:
- ✅ **字段重排**: 将紧急联系人和紧急联系电话移到前面
- ✅ **地址重命名**: "家庭住址" 更改为 "现居住地址"
- ✅ **字段移除**: 去除联系信息中的重复"联系电话"字段
- ✅ **位置调整**: 现居住地址放置在紧急联系人信息下方

**智能填充优化**:
- ✅ 身份证读卡器自动填充身份证地址到对应字段
- ✅ 同时智能填充现居住地址（如果为空）
- ✅ 表单验证规则同步更新

**用户体验提升**:
- 避免了字段重复，减少用户困惑
- 逻辑更清晰：基本信息→学籍信息→联系信息
- 字段命名更准确，符合实际使用场景

## 文件变更

### 修改的文件
- `frontend/src/views/Registration.vue` - 报名表单字段调整和优化

### 33. 身份证照片上传功能
**新增功能**: 在基本信息中添加身份证正面和反面照片上传

**功能特性**:
- ✅ **双面上传**: 支持身份证正面和反面照片分别上传
- ✅ **多种获取方式**: 支持手动上传和身份证读卡器自动获取
- ✅ **专用UI设计**: 身份证专用的上传区域，尺寸为200x120px
- ✅ **文件验证**: 支持图片格式验证，最大5MB限制
- ✅ **实时预览**: 上传后立即显示预览图片

**技术实现**:
```vue
<!-- 身份证正面照片 -->
<a-form-item label="身份证正面" name="idCardFront">
  <a-upload
    :before-upload="(file) => handleIdCardUpload(file, 'front')"
    accept="image/*"
  >
    <div class="id-card-upload-area">
      <img v-if="formData.idCardFront" :src="formData.idCardFront" />
      <div v-else class="id-card-placeholder">
        <i class="fas fa-id-card"></i>
        <p>身份证正面</p>
        <p>点击上传或使用读卡器</p>
      </div>
    </div>
  </a-upload>
</a-form-item>
```

**智能填充逻辑**:
- ✅ 读卡器获取头像时自动填充为身份证正面照片
- ✅ 支持读卡器直接获取身份证正反面完整照片
- ✅ 手动上传和自动获取可以混合使用

**用户体验优化**:
- 专用的身份证照片上传区域设计
- 清晰的视觉提示和操作引导
- 上传成功后的即时反馈
- 支持重新上传和替换

## 文件变更

### 修改的文件
- `frontend/src/views/Registration.vue` - 新增身份证照片上传功能

### 34. 修复身份证照片读取错误
**问题修复**: 修正身份证读卡器照片属性名错误

**问题描述**:
- ❌ 使用了错误的属性名 `frontImage` 和 `backImage`
- ❌ 头像和身份证正面照片逻辑混淆

**修复内容**:
- ✅ **属性名修正**: `frontImage` → `imageFront`, `backImage` → `imageBack`
- ✅ **逻辑优化**: 区分头像（base64Data）和完整身份证照片（imageFront/imageBack）
- ✅ **智能处理**: 优先使用完整照片，头像仅作为个人照片使用

**修复前**:
```typescript
// 错误的属性名
if (idCardData.frontImage) {
  formData.idCardFront = `data:image/jpeg;base64,${idCardData.frontImage}`
}
```

**修复后**:
```typescript
// 正确的属性名和逻辑
if (idCardData.imageFront) {
  formData.idCardFront = `data:image/jpeg;base64,${idCardData.imageFront}`
} else if (idCardData.base64Data && !formData.idCardFront) {
  console.log('读卡器获取到头像，建议手动上传完整的身份证正面照片')
}
```

**功能说明**:
- **头像（base64Data）**: 从身份证芯片读取的个人头像，用于个人照片字段
- **正面照片（imageFront）**: 完整的身份证正面照片，用于身份证正面字段
- **反面照片（imageBack）**: 完整的身份证反面照片，用于身份证反面字段

## 文件变更

### 修改的文件
- `frontend/src/views/Registration.vue` - 修复身份证照片读取错误

### 35. 身份证照片预览功能
**新增功能**: 点击身份证照片可以进行大图预览

**功能特性**:
- ✅ **点击预览**: 点击身份证正面或反面照片可打开预览模态框
- ✅ **大图显示**: 预览模态框中显示高清大图，最大高度500px
- ✅ **居中展示**: 预览图片居中显示，带有圆角和阴影效果
- ✅ **交互反馈**: 鼠标悬停时照片轻微放大，提示可点击
- ✅ **防止冲突**: 使用 `@click.stop` 防止触发上传操作

**技术实现**:
```vue
<!-- 身份证照片点击预览 -->
<img 
  v-if="formData.idCardFront" 
  :src="formData.idCardFront" 
  alt="身份证正面" 
  class="id-card-image" 
  @click.stop="previewIdCard('front')"
/>

<!-- 预览模态框 -->
<a-modal
  :open="previewVisible"
  :title="previewTitle"
  :footer="null"
  @cancel="handlePreviewCancel"
  centered
  width="600px"
>
  <div class="preview-image-container">
    <img :src="previewImage" :alt="previewTitle" class="preview-image" />
  </div>
</a-modal>
```

**用户体验优化**:
- **视觉提示**: 鼠标悬停时照片缩放至1.05倍，提示可点击
- **防误触**: 使用 `@click.stop` 阻止事件冒泡，避免触发上传
- **清晰展示**: 预览图片最大高度500px，确保清晰度
- **优雅关闭**: 点击模态框外部或关闭按钮可关闭预览

**响应式数据**:
```typescript
const previewVisible = ref<boolean>(false)    // 预览模态框显示状态
const previewImage = ref<string>('')          // 预览图片URL
const previewTitle = ref<string>('')          // 预览标题
```

## 文件变更

### 修改的文件
- `frontend/src/views/Registration.vue` - 新增身份证照片预览功能

### 36. 学员签到重构为签到记录
**功能重构**: 将学员签到管理页面重构为签到记录查看页面

**重构内容**:
- ✅ **页面定位改变**: 从实时签到管理改为历史记录查看分析
- ✅ **移除实时功能**: 移除人脸识别、手动签到、会话管理等实时功能
- ✅ **新增查询筛选**: 支持按日期范围、课程、状态、学员姓名筛选
- ✅ **统计分析**: 显示签到总数、缺席总数、迟到总数、签到率等统计
- ✅ **表格优化**: 增强记录表格显示，包含更多字段和分页功能

**新增查询功能**:
```vue
<!-- 查询筛选区域 -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  <a-range-picker v-model:value="dateRange" />          <!-- 日期范围 -->
  <a-select v-model:value="selectedCourseId" />         <!-- 课程筛选 -->
  <a-select v-model:value="selectedStatus" />           <!-- 状态筛选 -->
  <a-input v-model:value="searchStudentName" />         <!-- 姓名搜索 -->
</div>
```

**统计卡片**:
```vue
<!-- 四个统计卡片 -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
  <div>总签到数: {{ statistics.totalPresent }}</div>
  <div>总缺席数: {{ statistics.totalAbsent }}</div>
  <div>总迟到数: {{ statistics.totalLate }}</div>
  <div>签到率: {{ statistics.attendanceRate }}%</div>
</div>
```

**表格增强**:
- **更多字段**: 学员、课程、日期、时间、状态、方式、置信度、地点、备注
- **分页功能**: 支持页面大小调整和快速跳转
- **排序功能**: 按创建时间倒序显示
- **筛选逻辑**: 多条件组合筛选，实时更新统计

**计算属性重构**:
```typescript
const filteredRecords = computed(() => {
  // 多条件筛选逻辑：日期、课程、状态、姓名
})

const statistics = computed(() => {
  // 统计各种签到状态的数量和签到率
})

const paginatedRecords = computed(() => {
  // 分页处理筛选后的记录
})
```

**用户体验提升**:
- **快速筛选**: 支持多维度组合筛选，快速定位记录
- **直观统计**: 卡片式统计展示，一目了然掌握签到情况
- **导出功能**: 支持导出筛选后的签到记录
- **响应式表格**: 表格适配不同屏幕尺寸

## 文件变更

### 修改的文件
- `frontend/src/views/Attendance.vue` - 重构为签到记录查看页面

### 37. 签到记录分页中文化
**界面优化**: 修复分页组件中的英文显示问题

**修复内容**:
- ✅ **分页文本中文化**: 将 "20 / page" 改为 "20 条/页"
- ✅ **快速跳转中文化**: 设置跳转提示为 "跳至 X 页"
- ✅ **页面大小选项**: 提供 10/20/50/100 条记录选择
- ✅ **总数显示优化**: 显示格式为 "第 X-Y 条，共 Z 条记录"

**技术实现**:
```vue
<a-pagination
  :show-total="(total: number, range: [number, number]) => `第 ${range[0]}-${range[1]} 条，共 ${total} 条记录`"
  :page-size-options="['10', '20', '50', '100']"
  :show-size-changer-text="['条/页', '条/页']"
  :show-quick-jumper-text="['跳至', '页']"
/>
```

**用户体验提升**:
- **完全中文界面**: 消除英文显示，提供纯中文体验
- **清晰的分页信息**: 用户可清楚了解当前查看的记录范围
- **灵活的页面大小**: 支持不同的记录显示数量选择
- **快速导航**: 支持直接跳转到指定页面

## 文件变更

### 修改的文件
- `frontend/src/views/Attendance.vue` - 修复分页中文化显示

### 38. 完善权限管理系统
**系统重构**: 实现完整的基于角色的访问控制(RBAC)系统

**新增功能**:
- ✅ **角色权限管理页面** - 完整的角色管理界面，支持角色创建、编辑、权限分配
- ✅ **差异化用户界面** - 根据不同角色显示不同的页面内容和功能
- ✅ **细粒度权限控制** - 基于资源和操作的权限控制体系
- ✅ **动态菜单显示** - 根据用户权限动态显示可访问的菜单项

**角色权限管理功能**:
```typescript
// 角色管理界面特性
- 角色列表展示：显示所有系统角色和自定义角色
- 权限可视化：按资源分组显示权限，支持批量操作
- 角色编辑：支持角色名称、描述、图标、权限的完整编辑
- 系统角色保护：防止误删系统核心角色
- 权限统计：实时显示角色数量、权限数量等统计信息
```

**用户管理差异化**:
```vue
<!-- 管理员：完整用户管理 -->
<div v-if="authStore.isAdmin">
  <nav>全部用户 | 管理员 | 教师 | 学生</nav>
  <button>添加用户 | 导出数据</button>
</div>

<!-- 教师：仅学生管理 -->
<div v-else-if="authStore.isTeacher">
  <nav>我的学生</nav>
  <button>添加学生 | 导出数据</button>
</div>

<!-- 学生：无权限访问 -->
<div v-else>
  <p>您没有权限访问用户管理功能</p>
</div>
```

**设置页面差异化**:
```vue
<!-- 管理员：完整系统设置 -->
<div v-if="authStore.isAdmin">
  <div>基础设置 | 安全设置 | 用户权限</div>
  <div>邮件设置 | 短信设置 | 系统维护</div>
</div>

<!-- 教师/学生：个人设置 -->
<div v-else>
  <div>个人偏好 | 安全设置</div>
</div>
```

**权限系统架构**:
```typescript
// 权限定义
const DEFAULT_PERMISSIONS = {
  admin: ['system:*', 'user:*', 'student:*', 'teacher:*', 'course:*'],
  teacher: ['student:read', 'student:create', 'course:read', 'attendance:manage'],
  student: ['profile:read', 'profile:update', 'course:read', 'application:create']
}

// 权限检查
const canAccess = (requiredRoles?: UserRole[], requiredPermissions?: string[]) => {
  if (!isAuthenticated) return false
  if (requiredRoles && !hasRole(requiredRoles)) return false
  if (requiredPermissions && !requiredPermissions.every(p => hasPermission(p))) return false
  return true
}
```

**路由权限保护**:
```typescript
// 路由守卫增强
router.beforeEach((to, from, next) => {
  const requiredRoles = to.meta.roles as UserRole[]
  const requiredPermissions = to.meta.permissions as string[]
  
  if (!authStore.canAccess(requiredRoles, requiredPermissions)) {
    next('/') // 权限不足跳转首页
    return
  }
  next()
})
```

**用户体验优化**:
- **智能界面** - 根据角色自动调整界面布局和功能
- **权限提示** - 清晰显示用户权限范围和限制
- **操作反馈** - 权限不足时给出明确提示
- **数据安全** - 前端和后端双重权限验证

**新增文件**:
- `frontend/src/views/RoleManagement.vue` - 角色权限管理页面
- `frontend/src/components/RoleForm.vue` - 角色编辑表单组件

## 文件变更

### 新增的文件
- `frontend/src/views/RoleManagement.vue` - 角色权限管理页面
- `frontend/src/components/RoleForm.vue` - 角色表单组件

### 修改的文件
- `frontend/src/views/User.vue` - 根据角色差异化显示用户管理界面
- `frontend/src/views/Setting.vue` - 根据角色显示不同的设置选项
- `frontend/src/router/index.ts` - 添加角色管理路由，调整设置页面权限
- `frontend/src/components/BaseLayout.vue` - 添加角色权限管理菜单项

---

### 39. 四级权限系统升级 ⭐
**时间**: 2025-07-15 
**系统架构重构**: 升级为四级权限管理体系，提供更细粒度的权限控制

#### 🏗️ 权限体系架构
- ✅ **超级管理员 (SUPER_ADMIN)** - 公司最高权限，管理全系统
- ✅ **学校管理员 (SCHOOL_ADMIN)** - 学校级别管理，配置本校权限
- ✅ **教师 (TEACHER)** - 教学相关权限，管理课程和学生
- ✅ **学生 (STUDENT)** - 基础权限，查看和申请功能

#### 📊 权限配置详情

**超级管理员权限**:
```typescript
super_admin: [
  'system:*',        // 系统全部权限
  'user:*',          // 用户管理全权限
  'student:*',       // 学生管理全权限  
  'teacher:*',       // 教师管理全权限
  'course:*',        // 课程管理全权限
  'application:*',   // 报名管理全权限
  'analysis:*',      // 数据分析全权限
  'setting:*',       // 系统设置全权限
  'logs:*',          // 日志管理全权限
  'school:*'         // 学校管理全权限
]
```

**学校管理员权限**:
```typescript
school_admin: [
  'user:read', 'user:create', 'user:update',  // 用户基础管理
  'student:*',           // 学生管理全权限
  'teacher:*',           // 教师管理全权限
  'course:*',            // 课程管理全权限
  'application:*',       // 报名管理全权限
  'analysis:read',       // 数据分析查看
  'setting:read', 'setting:update'  // 部分系统设置
]
```

**教师权限**:
```typescript
teacher: [
  'student:read', 'student:create', 'student:update',  // 学生管理
  'course:*',            // 课程管理全权限
  'application:*',       // 报名管理全权限
  'attendance:manage',   // 签到管理
  'analysis:read'        // 数据分析查看
]
```

**学生权限**:
```typescript
student: [
  'profile:read', 'profile:update',    // 个人资料管理
  'course:read',                       // 课程查看
  'application:create', 'application:read'  // 报名申请和查看
]
```

#### 🔧 技术实现

**核心文件更新**:
- `frontend/src/types/auth.ts` - 更新用户角色枚举定义
- `frontend/src/utils/auth.ts` - 四级权限默认配置和颜色映射
- `frontend/src/utils/dev.ts` - 模拟用户数据和权限分配
- `frontend/src/router/index.ts` - 重构路由权限控制逻辑
- `frontend/src/views/RoleManagement.vue` - 角色管理界面重构

**权限系统特性**:
- ✅ 支持通配符权限（`resource:*`）
- ✅ 细粒度操作权限（read, create, update, delete）
- ✅ 层级化权限继承
- ✅ 动态路由权限检查
- ✅ UI界面差异化显示

#### 🧪 测试账户配置
```
超级管理员: 13800138000 / 123456 (superadmin@company.com)
学校管理员: 13800138001 / 123456 (schooladmin@school.com)
教师:       13800138002 / 123456 (teacher@school.com)
学生:       13800138003 / 123456 (student@school.com)
```

#### 💡 系统优势
1. **分层管理**: 公司-学校-教学-学习四级管理体系
2. **权限细化**: 更精确的权限控制，提高系统安全性
3. **扩展性强**: 支持多学校、多角色的复杂管理场景
4. **用户体验**: 不同角色看到不同的界面和功能
5. **易于维护**: 清晰的权限配置和角色定义

#### 📋 路由权限更新
- **仪表盘**: 所有角色可访问
- **学生管理**: 超级管理员、学校管理员、教师
- **用户管理**: 超级管理员、学校管理员
- **课程管理**: 超级管理员、学校管理员、教师
- **签到管理**: 超级管理员、学校管理员、教师
- **系统日志**: 超级管理员、学校管理员
- **角色权限**: 超级管理员、学校管理员
- **系统设置**: 所有角色（界面差异化）

#### 🔄 升级影响
- **向后兼容**: 现有功能保持正常运行
- **数据迁移**: 自动将原admin角色升级为super_admin
- **权限提升**: 新增学校管理员角色，提供中间层管理
- **安全增强**: 更严格的权限控制和验证机制 