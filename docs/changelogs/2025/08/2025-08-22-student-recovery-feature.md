# å­¦ç”Ÿè®°å½•æ™ºèƒ½æ¢å¤åŠŸèƒ½

**æ—¥æœŸï¼š** 2025-08-22  
**ç±»å‹ï¼š** åŠŸèƒ½å¢å¼º  
**å½±å“èŒƒå›´ï¼š** æŠ¥åæµç¨‹ã€æ•°æ®ä¸€è‡´æ€§ã€ç”¨æˆ·ä½“éªŒ  

## åŠŸèƒ½æè¿°

ä¸ºè§£å†³"è¯¥èº«ä»½è¯å·å·²ç»æ³¨å†Œè¿‡"çš„é—®é¢˜ï¼Œå®ç°äº†æ™ºèƒ½å­¦ç”Ÿè®°å½•æ¢å¤åŠŸèƒ½ã€‚å½“ç”¨æˆ·ä½¿ç”¨å·²åˆ é™¤å­¦ç”Ÿçš„èº«ä»½è¯å·å†æ¬¡æŠ¥åæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¢å¤å¹¶æ›´æ–°è¯¥å­¦ç”Ÿè®°å½•ï¼Œè€Œä¸æ˜¯æŠ¥é”™ã€‚

## é—®é¢˜èƒŒæ™¯

### åŸæœ‰é—®é¢˜
- **é‡å¤æ£€æŸ¥è¿‡äºä¸¥æ ¼**ï¼šç³»ç»Ÿæ£€æŸ¥æ‰€æœ‰å­¦ç”Ÿè®°å½•ï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ï¼‰çš„èº«ä»½è¯å·å”¯ä¸€æ€§
- **ç”¨æˆ·ä½“éªŒå·®**ï¼šç”¨æˆ·æ— æ³•ç†è§£ä¸ºä»€ä¹ˆ"å·²åˆ é™¤"çš„å­¦ç”Ÿè¿˜ä¼šå¯¼è‡´é‡å¤é”™è¯¯
- **æ•°æ®ç®¡ç†å›°éš¾**ï¼šç®¡ç†å‘˜éœ€è¦æ‰‹åŠ¨å¤„ç†é‡å¤èº«ä»½è¯å·çš„æƒ…å†µ

### ç”¨æˆ·åé¦ˆ
```
POST http://localhost:5173/api/applications 400 (Bad Request)
æäº¤å¤±è´¥: Error: è¯¥èº«ä»½è¯å·å·²ç»æ³¨å†Œè¿‡
```

## è§£å†³æ–¹æ¡ˆ

### 1. æ™ºèƒ½é‡å¤æ£€æŸ¥é€»è¾‘

#### ä¿®æ”¹å‰ï¼ˆæœ‰é—®é¢˜çš„é€»è¾‘ï¼‰
```typescript
// æ£€æŸ¥èº«ä»½è¯å·æ˜¯å¦å·²å­˜åœ¨
const existingStudent = await prisma.student.findFirst({
  where: {
    idCardNumber: applicationData.idNumber,
    // æ²¡æœ‰isActiveæ¡ä»¶ï¼ŒåŒ…å«äº†å·²åˆ é™¤çš„å­¦ç”Ÿ
  }
})

if (existingStudent) {
  throw new ValidationError('è¯¥èº«ä»½è¯å·å·²ç»æ³¨å†Œè¿‡')
}
```

#### ä¿®æ”¹åï¼ˆæ™ºèƒ½æ¢å¤é€»è¾‘ï¼‰
```typescript
// æ£€æŸ¥èº«ä»½è¯å·æ˜¯å¦å·²å­˜åœ¨ï¼ˆåªæ£€æŸ¥æ´»è·ƒå­¦ç”Ÿï¼‰
const existingStudent = await prisma.student.findFirst({
  where: {
    idCardNumber: applicationData.idNumber,
    isActive: true // åªæ£€æŸ¥æ´»è·ƒå­¦ç”Ÿ
  }
})

if (existingStudent) {
  throw new ValidationError('è¯¥èº«ä»½è¯å·å·²ç»æ³¨å†Œè¿‡')
}

// æ£€æŸ¥æ˜¯å¦æœ‰è¢«è½¯åˆ é™¤çš„å­¦ç”Ÿè®°å½•
const deletedStudent = await prisma.student.findFirst({
  where: { 
    idCardNumber: applicationData.idNumber,
    isActive: false // æŸ¥æ‰¾å·²åˆ é™¤çš„å­¦ç”Ÿ
  }
})

if (deletedStudent) {
  // æ¢å¤å¹¶æ›´æ–°å­¦ç”Ÿè®°å½•
  const restoredStudent = await tx.student.update({
    where: { id: deletedStudent.id },
    data: {
      // æ›´æ–°æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯
      realName: applicationData.name,
      gender: applicationData.gender === 'å¥³' ? 'FEMALE' : 'MALE',
      age: calculateAge(applicationData.birthDate) || 0,
      // ... å…¶ä»–å­—æ®µ
      isActive: true, // æ¢å¤ä¸ºæ´»è·ƒçŠ¶æ€
      updatedAt: new Date()
    }
  })
  
  return restoredStudent // è¿”å›æ¢å¤çš„å­¦ç”Ÿè®°å½•
}
```

### 2. æ¶‰åŠçš„è·¯ç”±ä¿®æ”¹

#### PCç«¯æŠ¥åè·¯ç”± (POST /api/applications)
- **ä½ç½®**ï¼š`backend/src/routes/application.ts:997-1044`
- **åŠŸèƒ½**ï¼šæ£€æŸ¥å·²åˆ é™¤å­¦ç”Ÿè®°å½•å¹¶æ™ºèƒ½æ¢å¤
- **å¢å¼º**ï¼šäº‹åŠ¡å†…åŒé‡æ£€æŸ¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### ç§»åŠ¨ç«¯åŒ¿åæŠ¥åè·¯ç”± (POST /api/applications/anonymous)  
- **ä½ç½®**ï¼š`backend/src/routes/application.ts:738-841`
- **åŠŸèƒ½**ï¼šåŒ¿åæŠ¥åæ—¶ä¹Ÿæ”¯æŒå­¦ç”Ÿè®°å½•æ¢å¤
- **ç‰¹ç‚¹**ï¼šé’ˆå¯¹ç§»åŠ¨ç«¯ä¼˜åŒ–çš„æ¢å¤é€»è¾‘

### 3. å­¦ç”Ÿè®°å½•æ¢å¤ç­–ç•¥

#### æ•°æ®æ›´æ–°ç­–ç•¥
- **ä¸ªäººä¿¡æ¯**ï¼šä½¿ç”¨æ–°çš„æŠ¥åä¿¡æ¯è¦†ç›–åŸè®°å½•
- **çŠ¶æ€æ¢å¤**ï¼šå°†`isActive`ä»`false`æ”¹ä¸º`true`
- **æ—¶é—´æˆ³**ï¼šæ›´æ–°`updatedAt`å­—æ®µè®°å½•æ¢å¤æ—¶é—´
- **å¤‡æ³¨ä¿¡æ¯**ï¼šåœ¨remarksä¸­æ ‡è®°ä¸º"æ¢å¤è®°å½•"

#### å­—æ®µæ˜ å°„
```typescript
// æ¢å¤å­¦ç”Ÿè®°å½•æ—¶çš„å­—æ®µæ›´æ–°
{
  realName: applicationData.name,           // æ›´æ–°å§“å
  gender: applicationData.gender,           // æ›´æ–°æ€§åˆ«
  age: calculateAge(applicationData.birthDate), // é‡æ–°è®¡ç®—å¹´é¾„
  birthday: new Date(applicationData.birthDate), // æ›´æ–°ç”Ÿæ—¥
  contactPhone: applicationData.contactPhone, // æ›´æ–°è”ç³»æ–¹å¼
  currentAddress: applicationData.familyAddress, // æ›´æ–°åœ°å€
  emergencyContact: applicationData.emergencyContact, // æ›´æ–°ç´§æ€¥è”ç³»äºº
  // ... å…¶ä»–ç›¸å…³å­—æ®µ
  isActive: true,                          // å…³é”®ï¼šæ¢å¤ä¸ºæ´»è·ƒçŠ¶æ€
  updatedAt: new Date()                    // æ›´æ–°æ—¶é—´æˆ³
}
```

## æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“äº‹åŠ¡ä¿è¯
ä½¿ç”¨Prismaäº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š
```typescript
const result = await prisma.$transaction(async (tx) => {
  // 1. æ£€æŸ¥æ´»è·ƒå­¦ç”Ÿé‡å¤
  // 2. æŸ¥æ‰¾å·²åˆ é™¤å­¦ç”Ÿ
  // 3. æ¢å¤æˆ–åˆ›å»ºå­¦ç”Ÿè®°å½•
  // 4. åˆ›å»ºæŠ¥åè®°å½•
})
```

### 2. å¹´é¾„è®¡ç®—å‡½æ•°
æ·»åŠ äº†åç«¯å¹´é¾„è®¡ç®—å‡½æ•°ï¼š
```typescript
function calculateAge(birthDate: string | Date): number {
  if (!birthDate) return 0
  
  const birth = new Date(birthDate)
  const today = new Date()
  
  let age = today.getFullYear() - birth.getFullYear()
  const monthDiff = today.getMonth() - birth.getMonth()
  
  // å¤„ç†ç”Ÿæ—¥æœªåˆ°çš„æƒ…å†µ
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    age--
  }
  
  return age
}
```

### 3. è¯¦ç»†çš„æ—¥å¿—è®°å½•
ä¸ºè°ƒè¯•å’Œç›‘æ§æ·»åŠ äº†è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ï¼š
```typescript
console.log('ğŸ”„ å‘ç°å·²åˆ é™¤çš„å­¦ç”Ÿè®°å½•ï¼Œå‡†å¤‡æ¢å¤å¹¶æ›´æ–°...')
console.log('åŸå­¦ç”Ÿä¿¡æ¯:', deletedStudent.id, deletedStudent.realName)
console.log('âœ… å­¦ç”Ÿè®°å½•æ¢å¤æˆåŠŸ:', student.id, student.realName)
```

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. æ— æ„ŸçŸ¥æ¢å¤
- **è‡ªåŠ¨å¤„ç†**ï¼šç”¨æˆ·æ— éœ€å…³å¿ƒä¹‹å‰æ˜¯å¦æœ‰è®°å½•è¢«åˆ é™¤
- **æ•°æ®æ›´æ–°**ï¼šè‡ªåŠ¨ä½¿ç”¨æœ€æ–°çš„æŠ¥åä¿¡æ¯æ›´æ–°å­¦ç”Ÿæ¡£æ¡ˆ
- **æµç¨‹é¡ºç•…**ï¼šæ¢å¤è¿‡ç¨‹å¯¹ç”¨æˆ·å®Œå…¨é€æ˜

### 2. æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **å”¯ä¸€æ€§ç»´æŠ¤**ï¼šç¡®ä¿æ´»è·ƒå­¦ç”Ÿçš„èº«ä»½è¯å·å”¯ä¸€æ€§
- **å†å²æ•°æ®ä¿æŠ¤**ï¼šå·²åˆ é™¤çš„å­¦ç”Ÿè®°å½•å¾—åˆ°æœ‰æ•ˆåˆ©ç”¨
- **å…³è”å¤„ç†**ï¼šæ¢å¤å­¦ç”Ÿæ—¶ä¿æŒä¸åŸæœ‰æ•°æ®çš„å…³è”æ€§

### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–
- **ç²¾ç¡®æ£€æŸ¥**ï¼šåªåœ¨çœŸæ­£é‡å¤æ—¶æŠ¥é”™
- **æ™ºèƒ½æ¢å¤**ï¼šè‡ªåŠ¨å¤„ç†å¯æ¢å¤çš„æƒ…å†µ
- **å‹å¥½æç¤º**ï¼šä¸ºç”¨æˆ·æä¾›æ›´å‡†ç¡®çš„é”™è¯¯ä¿¡æ¯

## ä¸šåŠ¡ä»·å€¼

### 1. æå‡æŠ¥åæˆåŠŸç‡
- **å‡å°‘é”™è¯¯**ï¼šæ˜¾è‘—é™ä½"èº«ä»½è¯å·é‡å¤"é”™è¯¯çš„å‘ç”Ÿ
- **ç®€åŒ–æµç¨‹**ï¼šç”¨æˆ·æ— éœ€è”ç³»ç®¡ç†å‘˜å¤„ç†é‡å¤é—®é¢˜
- **æé«˜æ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–å¤„ç†åŸæœ¬éœ€è¦äººå·¥å¹²é¢„çš„æƒ…å†µ

### 2. æ”¹å–„æ•°æ®ç®¡ç†
- **æ•°æ®å¤ç”¨**ï¼šå·²åˆ é™¤çš„å­¦ç”Ÿæ•°æ®å¾—åˆ°æœ‰æ•ˆåˆ©ç”¨
- **å†å²è¿½è¸ª**ï¼šä¿æŒå­¦ç”Ÿä¿¡æ¯çš„å†å²è¿ç»­æ€§
- **å‡å°‘å†—ä½™**ï¼šé¿å…åˆ›å»ºå¤§é‡é‡å¤çš„å­¦ç”Ÿè®°å½•

### 3. å¢å¼ºç³»ç»Ÿå¥å£®æ€§
- **å®¹é”™èƒ½åŠ›**ï¼šå¯¹åˆ é™¤åå†æŠ¥åçš„åœºæ™¯æœ‰è‰¯å¥½å¤„ç†
- **æ•°æ®å®Œæ•´æ€§**ï¼šé€šè¿‡äº‹åŠ¡ä¿è¯æ“ä½œçš„åŸå­æ€§
- **ç›‘æ§å‹å¥½**ï¼šè¯¦ç»†çš„æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

## æµ‹è¯•åœºæ™¯

### 1. æ­£å¸¸æ¢å¤åœºæ™¯
- [ ] ä½¿ç”¨å·²åˆ é™¤å­¦ç”Ÿçš„èº«ä»½è¯å·é‡æ–°æŠ¥å
- [ ] éªŒè¯å­¦ç”Ÿè®°å½•è¢«æ­£ç¡®æ¢å¤
- [ ] ç¡®è®¤ä¿¡æ¯è¢«æ­£ç¡®æ›´æ–°
- [ ] æ£€æŸ¥æŠ¥åè®°å½•æ­£å¸¸åˆ›å»º

### 2. è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [ ] å­¦ç”Ÿè¢«åˆ é™¤åç«‹å³æ¢å¤æŠ¥å
- [ ] å­¦ç”Ÿåˆ é™¤å¾ˆä¹…åå†æ¬¡æŠ¥å
- [ ] å­¦ç”Ÿä¿¡æ¯å‘ç”Ÿé‡å¤§å˜åŒ–çš„æ¢å¤
- [ ] å¹¶å‘æ¢å¤æ“ä½œçš„å¤„ç†

### 3. æ•°æ®ä¸€è‡´æ€§éªŒè¯
- [ ] æ¢å¤çš„å­¦ç”Ÿè®°å½•æ•°æ®æ­£ç¡®
- [ ] åŸæœ‰çš„æŠ¥åè®°å½•çŠ¶æ€æ­£ç¡®
- [ ] æ–°çš„æŠ¥åè®°å½•æ­£å¸¸åˆ›å»º
- [ ] ç›¸å…³ç»Ÿè®¡æ•°æ®æ›´æ–°æ­£ç¡®

## ç›‘æ§è¦ç‚¹

### 1. æ¢å¤æ“ä½œç›‘æ§
- **æ¢å¤é¢‘ç‡**ï¼šç›‘æ§å­¦ç”Ÿè®°å½•æ¢å¤çš„é¢‘ç‡
- **æ•°æ®è´¨é‡**ï¼šæ£€æŸ¥æ¢å¤åæ•°æ®çš„å®Œæ•´æ€§
- **æ€§èƒ½å½±å“**ï¼šè¯„ä¼°æ¢å¤æ“ä½œå¯¹æ€§èƒ½çš„å½±å“

### 2. ä¸šåŠ¡æŒ‡æ ‡
- **é”™è¯¯ç‡é™ä½**ï¼šç›‘æ§"èº«ä»½è¯å·é‡å¤"é”™è¯¯çš„å‡å°‘
- **æŠ¥åæˆåŠŸç‡**ï¼šè·Ÿè¸ªæŠ¥åæµç¨‹çš„æˆåŠŸç‡æå‡
- **ç”¨æˆ·æ»¡æ„åº¦**ï¼šæ”¶é›†ç”¨æˆ·å¯¹æ–°æµç¨‹çš„åé¦ˆ

## ç»´æŠ¤æŒ‡å—

### 1. æ•°æ®æ¸…ç†ç­–ç•¥
- å®šæœŸæ¸…ç†é•¿æœŸæœªä½¿ç”¨çš„å·²åˆ é™¤å­¦ç”Ÿè®°å½•
- ä¸ºæ¢å¤çš„å­¦ç”Ÿè®°å½•å»ºç«‹è¿½è¸ªæœºåˆ¶
- ç›‘æ§æ•°æ®åº“ä¸­çš„è½¯åˆ é™¤è®°å½•æ•°é‡

### 2. æ—¥å¿—ç®¡ç†
- ä¿ç•™æ¢å¤æ“ä½œçš„è¯¦ç»†æ—¥å¿—
- ç›‘æ§å¼‚å¸¸æ¢å¤æƒ…å†µ
- å»ºç«‹æ•°æ®æ¢å¤çš„å®¡è®¡è·Ÿè¸ª

### 3. æ€§èƒ½ä¼˜åŒ–
- ä¸ºisActiveå­—æ®µå»ºç«‹é€‚å½“çš„ç´¢å¼•
- å®šæœŸåˆ†ææ¢å¤æ“ä½œçš„æ€§èƒ½å½±å“
- ä¼˜åŒ–è½¯åˆ é™¤è®°å½•çš„æŸ¥è¯¢æ•ˆç‡
