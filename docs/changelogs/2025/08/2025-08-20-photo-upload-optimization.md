# 2025-08-20 ç…§ç‰‡ä¸Šä¼ ä¼˜åŒ–

## ğŸ¯ é—®é¢˜æè¿°

**åŸå§‹é—®é¢˜**: èº«ä»½è¯è¯»å–æ—¶æ¯æ¬¡éƒ½ä¼šç«‹å³ä¸Šä¼ ç…§ç‰‡ï¼Œå¯¼è‡´ï¼š
- âŒ é‡å¤ä¸Šä¼ ç›¸åŒèº«ä»½è¯çš„ç…§ç‰‡
- âŒ ç½‘ç»œèµ„æºæµªè´¹
- âŒ ç”¨æˆ·ä½“éªŒä¸ä½³ï¼ˆé¢‘ç¹ä¸Šä¼ æç¤ºï¼‰
- âŒ æœåŠ¡å™¨å­˜å‚¨ç©ºé—´æµªè´¹

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
**ä»"ç«‹å³ä¸Šä¼ "æ”¹ä¸º"å»¶è¿Ÿä¸Šä¼  + é‡å¤æ£€æµ‹"**

```
ä¿®å¤å‰ï¼šè¯»å–èº«ä»½è¯ â†’ ç«‹å³ä¸Šä¼ ç…§ç‰‡ â†’ é‡å¤ä¸Šä¼ 
ä¿®å¤åï¼šè¯»å–èº«ä»½è¯ â†’ æ£€æŸ¥ç”¨æˆ·å­˜åœ¨æ€§ â†’ æš‚å­˜ç…§ç‰‡ â†’ æäº¤æ—¶ç»Ÿä¸€ä¸Šä¼ 
```

### æŠ€æœ¯å®ç°

#### 1. æ•°æ®åº“æ¨¡å¼æ›´æ–°
**æ–‡ä»¶**: `backend/prisma/schema.prisma`

```prisma
model Student {
  // ... å…¶ä»–å­—æ®µ ...
  photo             String?      // ğŸ†• ä¸ªäººç…§ç‰‡URL
  idCardFront       String?      // èº«ä»½è¯æ­£é¢
  idCardBack        String?      // èº«ä»½è¯èƒŒé¢
  // ... å…¶ä»–å­—æ®µ ...
}
```

**æ‰§è¡Œçš„è¿ç§»**:
```bash
npx prisma migrate dev --name add-student-photo-field
```

#### 2. å‰ç«¯æš‚å­˜æœºåˆ¶
**æ–‡ä»¶**: `frontend/src/views/Registration.vue`

**æ–°å¢æš‚å­˜æ•°æ®ç»“æ„**:
```typescript
// æš‚å­˜ç…§ç‰‡æ•°æ®ï¼Œé¿å…é‡å¤ä¸Šä¼ 
const pendingPhotoData = ref({
  photo: '',        // ä¸ªäººå¤´åƒbase64
  idCardFront: '',  // èº«ä»½è¯æ­£é¢base64
  idCardBack: ''    // èº«ä»½è¯èƒŒé¢base64
})
```

#### 3. è¯»å¡ä¼˜åŒ–é€»è¾‘
**æ–‡ä»¶**: `frontend/src/views/Registration.vue`

**ä¿®å¤å‰ (ç«‹å³ä¸Šä¼ )**:
```typescript
// âŒ æ¯æ¬¡è¯»å¡éƒ½ç«‹å³ä¸Šä¼ 
if (idCardData.base64Data) {
  const photoUrl = await uploadBase64Image(base64Photo, 'photo')
  formData.photo = photoUrl
}
```

**ä¿®å¤å (æ™ºèƒ½å¤„ç†)**:
```typescript
// âœ… å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
if (formData.idNumber) {
  const checkResponse = await ApplicationService.checkIdNumber(formData.idNumber)
  if (checkResponse.data.exists) {
    // ç”¨æˆ·å·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦æ›´æ–°ç…§ç‰‡
    Modal.confirm({
      title: 'èº«ä»½è¯å·å·²å­˜åœ¨',
      content: 'æ˜¯å¦è¦æ›´æ–°ç…§ç‰‡ä¿¡æ¯ï¼Ÿ',
      onOk: () => processIdCardPhotos(idCardData)
    })
    return
  }
}

// æ–°ç”¨æˆ·ï¼šæš‚å­˜ç…§ç‰‡ï¼Œç­‰æäº¤æ—¶ä¸Šä¼ 
await processIdCardPhotos(idCardData)
```

#### 4. æ‰¹é‡ä¸Šä¼ æœºåˆ¶
**æ–‡ä»¶**: `frontend/src/views/Registration.vue`

**ç»Ÿä¸€ä¸Šä¼ å‡½æ•°**:
```typescript
const uploadPendingPhotos = async (): Promise<void> => {
  // æ‰¹é‡ä¸Šä¼ æ‰€æœ‰æš‚å­˜çš„ç…§ç‰‡
  if (pendingPhotoData.value.photo?.startsWith('data:')) {
    const photoUrl = await uploadBase64Image(pendingPhotoData.value.photo, 'photo')
    if (photoUrl) formData.photo = photoUrl
  }
  
  if (pendingPhotoData.value.idCardFront?.startsWith('data:')) {
    const frontUrl = await uploadBase64Image(pendingPhotoData.value.idCardFront, 'front')
    if (frontUrl) formData.idCardFront = frontUrl
  }
  
  if (pendingPhotoData.value.idCardBack?.startsWith('data:')) {
    const backUrl = await uploadBase64Image(pendingPhotoData.value.idCardBack, 'back')
    if (backUrl) formData.idCardBack = backUrl
  }
}
```

#### 5. æäº¤æµç¨‹ä¼˜åŒ–
**æ–‡ä»¶**: `frontend/src/views/Registration.vue`

```typescript
const handleSubmit = async (): Promise<void> => {
  // 1. è¡¨å•éªŒè¯
  await formRef.value.validate()
  
  // 2. æ‰¹é‡ä¸Šä¼ æš‚å­˜ç…§ç‰‡
  await uploadPendingPhotos()
  
  // 3. æäº¤ç”³è¯·æ•°æ®
  const response = await ApplicationService.submitApplication(submitData)
  
  // 4. æˆåŠŸåæ¸…ç†
  if (response.code === 200) {
    handleReset()
    clearPendingPhotos()
  }
}
```

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### æ€§èƒ½æå‡
- ğŸš€ **ç½‘ç»œè¯·æ±‚å‡å°‘**: ä»å¤šæ¬¡ä¸Šä¼ åˆ°ä¸€æ¬¡æ‰¹é‡ä¸Šä¼ 
- ğŸ“Š **å­˜å‚¨ä¼˜åŒ–**: é¿å…é‡å¤å­˜å‚¨ç›¸åŒç”¨æˆ·çš„ç…§ç‰‡
- âš¡ **å“åº”é€Ÿåº¦**: èº«ä»½è¯è¯»å–å³æ—¶å“åº”ï¼Œæ— éœ€ç­‰å¾…ä¸Šä¼ 

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
- ğŸ“± **æµç•…æ“ä½œ**: è¯»å¡æ— å»¶è¿Ÿï¼Œæäº¤æ—¶ç»Ÿä¸€å¤„ç†
- ğŸ’¬ **æ™ºèƒ½æç¤º**: é‡å¤ç”¨æˆ·æœ‰é€‰æ‹©æƒ
- ğŸ¯ **æ“ä½œæ˜ç¡®**: ç”¨æˆ·çŸ¥é“ä½•æ—¶ä¼šä¸Šä¼ ç…§ç‰‡

### æ•°æ®å®Œæ•´æ€§
- âœ… **å­—æ®µæ˜ å°„**: `Student.photo` å­—æ®µæ­£ç¡®ä¿å­˜ä¸ªäººå¤´åƒ
- âœ… **URLå­˜å‚¨**: ç»Ÿä¸€å­˜å‚¨æ–‡ä»¶è·¯å¾„ï¼Œä¸å­˜å‚¨base64
- âœ… **é»˜è®¤å¤„ç†**: æœªä¸Šä¼ ç…§ç‰‡æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ

## ğŸ“Š å¯¹æ¯”åˆ†æ

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿›æ•ˆæœ |
|------|--------|--------|----------|
| **ä¸Šä¼ æ—¶æœº** | è¯»å¡æ—¶ç«‹å³ä¸Šä¼  | æäº¤æ—¶æ‰¹é‡ä¸Šä¼  | â¬†ï¸ å‡å°‘ç½‘ç»œè¯·æ±‚ |
| **é‡å¤å¤„ç†** | æ— æ£€æµ‹ï¼Œé‡å¤ä¸Šä¼  | æ™ºèƒ½æ£€æµ‹ï¼Œç”¨æˆ·é€‰æ‹© | â¬†ï¸ é¿å…é‡å¤å­˜å‚¨ |
| **ç”¨æˆ·ä½“éªŒ** | é¢‘ç¹æç¤ºä¸Šä¼  | ä¸€æ¬¡æ€§å¤„ç† | â¬†ï¸ æ“ä½œæ›´æµç•… |
| **æ•°æ®å­˜å‚¨** | å¯èƒ½é‡å¤å­˜å‚¨ | é¿å…é‡å¤ï¼Œä¼˜åŒ–å­˜å‚¨ | â¬†ï¸ èŠ‚çœç©ºé—´ |
| **é”™è¯¯å¤„ç†** | åˆ†æ•£çš„é”™è¯¯å¤„ç† | é›†ä¸­é”™è¯¯å¤„ç† | â¬†ï¸ æ›´å¥½çš„é”™è¯¯åé¦ˆ |

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç…§ç‰‡å¤„ç†æµç¨‹
```mermaid
graph TD
    A[è¯»å–èº«ä»½è¯] --> B{æ£€æŸ¥èº«ä»½è¯å·}
    B -->|å·²å­˜åœ¨| C[è¯¢é—®ç”¨æˆ·æ˜¯å¦æ›´æ–°]
    B -->|ä¸å­˜åœ¨| D[æš‚å­˜ç…§ç‰‡æ•°æ®]
    C -->|ç¡®è®¤æ›´æ–°| D
    C -->|å–æ¶ˆ| E[è·³è¿‡ç…§ç‰‡å¤„ç†]
    D --> F[æ˜¾ç¤ºé¢„è§ˆ]
    F --> G[ç”¨æˆ·æäº¤è¡¨å•]
    G --> H[æ‰¹é‡ä¸Šä¼ ç…§ç‰‡]
    H --> I[ä¿å­˜åˆ°æ•°æ®åº“]
    I --> J[æ¸…é™¤æš‚å­˜æ•°æ®]
```

### æ•°æ®æµè½¬
```
èº«ä»½è¯è¯»å¡å™¨ â†’ base64æ•°æ® â†’ pendingPhotoDataæš‚å­˜ â†’ è¡¨å•æäº¤è§¦å‘ â†’ æ‰¹é‡ä¸Šä¼ API â†’ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨ â†’ æ•°æ®åº“ä¿å­˜URL â†’ å‰ç«¯å±•ç¤º
```

### é˜²é‡å¤æœºåˆ¶
1. **èº«ä»½è¯å·æ£€æŸ¥**: è¯»å¡å‰æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
2. **ç”¨æˆ·ç¡®è®¤**: é‡å¤ç”¨æˆ·å¯é€‰æ‹©æ˜¯å¦æ›´æ–°ç…§ç‰‡
3. **æš‚å­˜ç®¡ç†**: æœªæäº¤çš„ç…§ç‰‡æ•°æ®ä¸´æ—¶å­˜å‚¨
4. **æ¸…ç†æœºåˆ¶**: æäº¤æˆåŠŸæˆ–é‡ç½®æ—¶æ¸…é™¤æš‚å­˜

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç”¨æˆ·äº¤äº’
- ğŸ”” **æ˜ç¡®æç¤º**: å‘ŠçŸ¥ç”¨æˆ·ç…§ç‰‡å°†åœ¨æäº¤æ—¶ä¸Šä¼ 
- âš™ï¸ **é€‰æ‹©æƒé™**: é‡å¤ç”¨æˆ·å¯å†³å®šæ˜¯å¦æ›´æ–°ç…§ç‰‡
- ğŸ“± **é¢„è§ˆåŠŸèƒ½**: æš‚å­˜ç…§ç‰‡å¯å®æ—¶é¢„è§ˆ

### æ•°æ®å®‰å…¨
- ğŸ”’ **å†…å­˜ç®¡ç†**: æš‚å­˜æ•°æ®åœ¨æäº¤åç«‹å³æ¸…é™¤
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**: base64æ•°æ®éªŒè¯åå†ä¸Šä¼ 
- ğŸ“‹ **æ—¥å¿—è®°å½•**: å®Œæ•´çš„ä¸Šä¼ è¿‡ç¨‹æ—¥å¿—

---

**å¼€å‘è€…**: AI Assistant  
**æµ‹è¯•çŠ¶æ€**: âœ… é€»è¾‘éªŒè¯å®Œæˆ  
**æ€§èƒ½å½±å“**: ğŸš€ **æ˜¾è‘—æå‡** - å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚  
**ç”¨æˆ·ä»·å€¼**: ğŸ¯ **ä½“éªŒä¼˜åŒ–** - æ›´æµç•…çš„æŠ¥åæµç¨‹  
