# 2025-08-18 变更日志

## 🚀 新功能

### 多课程报名系统
- **新增报名申请API路由** (`backend/src/routes/application.ts`)
  - 创建 `/api/applications/available-courses` 接口，返回可报名课程列表
  - 创建 `/api/applications/check-id` 接口，检查身份证号重复
  - 创建 `/api/applications/validate` 接口，验证报名表单
  - 创建 `POST /api/applications` 接口，支持多课程报名提交

### 智能课程选择与冲突检测
- **前端多选课程功能** (`frontend/src/views/Registration.vue`)
  - 支持最多选择2门课程的多选下拉框
  - 实时显示已选课程信息和时间安排
  - 动态更新课程可用状态（满员/时间冲突自动禁用）
  
- **时间冲突检测算法**
  - 前端实时检测：用户选择时立即提示时间冲突
  - 后端验证：服务器端再次验证，确保数据完整性
  - 智能提示：显示具体冲突的课程名称

### 图片存储优化
- **身份证照片处理优化**
  - 将base64图片数据转换为实际文件存储
  - 自动创建 `/uploads/id-cards/` 目录结构
  - 生成唯一文件名：`idcard_front_1692374025_a1b2c3.jpeg`
  - 数据库存储文件路径而非base64数据
  - 添加静态文件服务：`/uploads` 路径访问图片

## 🔧 功能优化

### 课程管理界面
- **课程表显示完善** (`frontend/src/views/Course.vue`)
  - 修复星期六课程显示问题（扩展到6天显示）
  - 添加'晚上'时间段支持（7:00-9:00）
  - 优化中文类别和级别的显示映射
  - 完善课程详情信息展示

### API性能提升
- **数据库查询优化**
  - 课程列表接口返回完整时间段数据 (`timeSlots`)
  - 优化关联查询，减少数据库访问次数
  - 增加API速率限制到1000请求/窗口（开发环境）

## 🐛 错误修复

### 后端API修复
- **修复报名提交500错误**
  - 移除数据库模型中不存在的字段引用
  - 修复性别枚举值映射 (`'女' → 'FEMALE'`, `'男' → 'MALE'`)
  - 添加必需的 `enrollmentCode` 和 `createdBy` 字段
  
- **修复数据验证错误**
  - 修复 `validatePaginationData.validate()` 调用方式
  - 完善必填字段验证和错误消息

### 前端界面修复
- **修复Vue组件渲染错误**
  - 解决 `ageRestriction.enabled` 未定义错误
  - 修复教师信息、费用、位置字段的数据映射
  - 优化课程数据结构与后端API的匹配

## 📊 技术架构改进

### 文件上传架构
```
前端 base64 → 后端解析 → 文件系统存储 → 数据库路径记录
```

### 数据库优化
- **存储效率提升**: base64转文件存储，减少数据库大小约70%
- **查询性能**: 移除大数据字段，提升查询速度
- **扩展性**: 便于后续迁移到云存储服务

### API设计改进
- **统一响应格式**: `{ code, message, data }` 
- **错误处理**: 完善的业务异常和验证异常处理
- **日志记录**: 详细的用户操作和系统错误日志

## 🔄 数据流程优化

### 报名流程
```mermaid
graph LR
    A[用户选择课程] --> B[时间冲突检测]
    B --> C[填写个人信息]
    C --> D[上传身份证照片]
    D --> E[转换为文件存储]
    E --> F[提交到后端验证]
    F --> G[创建学员记录]
    G --> H[创建报名记录]
    H --> I[返回成功响应]
```

## 📁 文件变更统计

### 新增文件
- `backend/src/routes/application.ts` - 报名申请路由
- `backend/uploads/` - 图片文件存储目录

### 修改文件
- `frontend/src/views/Registration.vue` - 报名页面重构
- `frontend/src/views/Course.vue` - 课程管理界面优化
- `frontend/src/api/application.ts` - API接口更新
- `backend/src/index.ts` - 静态文件服务和路由注册
- `backend/src/routes/course.ts` - 课程查询修复

## 🎯 下一步计划

### 即将开发
- [ ] 报名申请审核工作流
- [ ] 学员档案管理界面
- [ ] 课程排课冲突可视化
- [ ] 支付集成模块

### 技术债务
- [ ] 单元测试覆盖率提升
- [ ] API文档自动生成完善
- [ ] 性能监控和告警机制

---

**开发者**: AI Assistant  
**审核者**: 待指定  
**影响范围**: 报名系统核心功能  
**兼容性**: 向后兼容，无破坏性更改  
**部署要求**: 需要重启后端服务，确保 `uploads` 目录权限
