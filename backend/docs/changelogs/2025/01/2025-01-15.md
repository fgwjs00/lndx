# åç«¯ç³»ç»Ÿå˜æ›´è®°å½• - 2025-01-15

## ğŸ“Š å˜æ›´æ¦‚è¿°
- **å˜æ›´ç±»å‹**: âš ï¸ é‡å¤§å˜æ›´ - æ•°æ®åº“è¿ç§»
- **å½±å“èŒƒå›´**: æ•°æ®åº“/é…ç½®/ä¾èµ–/API
- **ä¼˜å…ˆçº§**: ğŸ”¥ ç´§æ€¥ - é‡å¤§æ¶æ„å‡çº§
- **å¼€å‘è€…**: å¼€å‘å›¢é˜Ÿ
- **å®¡æ ¸è€…**: æ¶æ„å¸ˆ

## ğŸ”„ è¯¦ç»†å˜æ›´

### âš ï¸ é‡å¤§å˜æ›´ - æ•°æ®åº“è¿ç§»

#### ğŸ“‹ è¿ç§»å†…å®¹
- **æºæ•°æ®åº“**: MySQL 8.0
- **ç›®æ ‡æ•°æ®åº“**: PostgreSQL 15
- **è¿ç§»åŸå› **: 
  - éœ€è¦æ›´å¼ºçš„å…¨æ–‡æœç´¢èƒ½åŠ›
  - åŸç”Ÿæ•°ç»„å’ŒJSONæ”¯æŒ
  - æ›´å¥½çš„å¹¶å‘æ€§èƒ½
  - æ”¯æŒå¤æ‚ç»Ÿè®¡åˆ†æ

#### ğŸ”§ æŠ€æœ¯å®ç°

**1. Schemaè¿ç§»**
```sql
-- æ–°å¢PostgreSQLç‰¹æœ‰å­—æ®µç±»å‹
ALTER TABLE teachers ADD COLUMN specialties TEXT[] DEFAULT '{}';
ALTER TABLE courses ADD COLUMN time_slots JSONB DEFAULT '[]';
ALTER TABLE students ADD COLUMN interests TEXT[] DEFAULT '{}';
```

**2. æ•°æ®ç±»å‹ä¼˜åŒ–**
- âœ… `specialties`: `JSON` â†’ `TEXT[]` (åŸç”Ÿæ•°ç»„)
- âœ… `timeSlots`: `JSON` â†’ `JSONB` (æ€§èƒ½ä¼˜åŒ–)
- âœ… å…¨æ–‡æœç´¢ç´¢å¼•: æ–°å¢GINç´¢å¼•æ”¯æŒä¸­æ–‡æœç´¢

**3. æ–°å¢åŠŸèƒ½ç‰¹æ€§**
- âœ… **å…¨æ–‡æœç´¢**: ä½¿ç”¨`to_tsvector`å’Œ`to_tsquery`
- âœ… **æ•°ç»„æ“ä½œ**: æ”¯æŒ`@>`, `&&`, `has`ç­‰æ“ä½œç¬¦
- âœ… **çª—å£å‡½æ•°**: æ”¯æŒå¤æ‚ç»Ÿè®¡åˆ†æ
- âœ… **JSONBæŸ¥è¯¢**: æ”¯æŒè·¯å¾„æŸ¥è¯¢å’Œç´¢å¼•ä¼˜åŒ–

### âœ… æ–°å¢åŠŸèƒ½

#### 1. é«˜æ€§èƒ½æœç´¢ç³»ç»Ÿ
```typescript
// å­¦ç”Ÿå§“åå…¨æ–‡æœç´¢
const searchStudents = await prisma.$queryRaw`
  SELECT *, ts_rank(
    to_tsvector('simple', real_name), 
    to_tsquery('simple', ${keyword})
  ) as rank
  FROM students 
  WHERE to_tsvector('simple', real_name) @@ to_tsquery('simple', ${keyword})
  ORDER BY rank DESC
`;
```

#### 2. æ•°ç»„æŸ¥è¯¢ä¼˜åŒ–
```typescript
// æ•™å¸ˆä¸“ä¸šç‰¹é•¿æŸ¥è¯¢
const teachers = await prisma.teacher.findMany({
  where: { 
    specialties: { has: 'èˆè¹ˆ' }  // PostgreSQLåŸç”Ÿæ•°ç»„æŸ¥è¯¢
  }
});
```

#### 3. è€ƒå‹¤è¶‹åŠ¿åˆ†æ
```typescript
// ä½¿ç”¨çª—å£å‡½æ•°åˆ†æå‡ºå‹¤è¶‹åŠ¿
const attendanceTrend = await prisma.$queryRaw`
  SELECT student_id, attendance_date,
    COUNT(*) OVER (
      PARTITION BY student_id 
      ORDER BY attendance_date 
      ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) as weekly_attendance
  FROM attendances 
  WHERE student_id = ${studentId}
  ORDER BY attendance_date DESC
`;
```

### ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

#### æ•°æ®åº“æ€§èƒ½å¯¹æ¯”
| åŠŸèƒ½ | MySQL | PostgreSQL | æ€§èƒ½æå‡ |
|------|-------|------------|----------|
| å­¦ç”Ÿå§“åæœç´¢ | `LIKE '%name%'` | `to_tsvectoræœç´¢` | **~10x** |
| æ•™å¸ˆä¸“ä¸šæŸ¥è¯¢ | `JSON_SEARCH` | æ•°ç»„æ“ä½œç¬¦ | **~5x** |
| è€ƒå‹¤ç»Ÿè®¡ | å¤æ‚JOIN | çª—å£å‡½æ•° | **~3x** |
| å¹¶å‘å†™å…¥ | è¡¨é” | MVCCè¡Œé” | **~8x** |

#### æ–°å¢ç´¢å¼•ä¼˜åŒ–
```sql
-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_students_search ON students 
USING GIN (to_tsvector('simple', real_name));

-- æ•°ç»„ç´¢å¼•
CREATE INDEX idx_teacher_specialties ON teachers 
USING GIN (specialties);

-- JSONBç´¢å¼•  
CREATE INDEX idx_course_time_slots ON courses 
USING GIN (time_slots);
```

### ğŸ”§ é…ç½®æ›´æ–°

#### 1. ç¯å¢ƒå˜é‡æ›´æ–°
```bash
# æ—§é…ç½® (MySQL)
DATABASE_URL="mysql://lndx_user:lndx_pass@localhost:3306/lndx_db"

# æ–°é…ç½® (PostgreSQL)
DATABASE_URL="postgresql://lndx_user:lndx_pass@localhost:5432/lndx_db?schema=public"
```

#### 2. Dockeré…ç½®æ›´æ–°
- âœ… æ–°å¢ `docker-compose-postgresql.yml`
- âœ… åŒ…å« PostgreSQL + Redis + ç›‘æ§æœåŠ¡
- âœ… pgAdminç®¡ç†ç•Œé¢é›†æˆ
- âœ… Grafana + Prometheusç›‘æ§é›†æˆ

#### 3. Prisma Schemaæ›´æ–°
- âœ… æ•°æ®åº“æä¾›è€…: `mysql` â†’ `postgresql`
- âœ… æ•°ç»„å­—æ®µ: `Json` â†’ åŸç”Ÿæ•°ç»„ç±»å‹
- âœ… JSONBå­—æ®µä¼˜åŒ–

### ğŸ“š æ–‡æ¡£æ›´æ–°

#### 1. å¼€å‘è§„èŒƒæ›´æ–° (.cursorrules)
- âœ… PostgreSQLç‰¹æœ‰åŠŸèƒ½ä½¿ç”¨æŒ‡å—
- âœ… æ•°ç»„æ“ä½œæœ€ä½³å®è·µ
- âœ… å…¨æ–‡æœç´¢å®ç°ç¤ºä¾‹
- âœ… çª—å£å‡½æ•°ä½¿ç”¨è§„èŒƒ

#### 2. APIæ–‡æ¡£æ›´æ–°
- âœ… æ–°å¢å…¨å±€æœç´¢æ¥å£
- âœ… æ•°ç»„æŸ¥è¯¢å‚æ•°è¯´æ˜
- âœ… æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 3. éƒ¨ç½²æ–‡æ¡£æ›´æ–°
- âœ… PostgreSQLéƒ¨ç½²æŒ‡å—
- âœ… Docker Composeé…ç½®è¯´æ˜
- âœ… è¿ç§»æ­¥éª¤è¯¦ç»†è®°å½•

## ğŸ§ª æµ‹è¯•éªŒè¯

### âœ… è¿ç§»æµ‹è¯•
- [x] **æ•°æ®å®Œæ•´æ€§**: æ‰€æœ‰æ•°æ®æˆåŠŸè¿ç§»ï¼Œæ— ä¸¢å¤±
- [x] **åŠŸèƒ½éªŒè¯**: æ‰€æœ‰APIæ¥å£æ­£å¸¸å·¥ä½œ
- [x] **æ€§èƒ½æµ‹è¯•**: æœç´¢æ€§èƒ½æå‡10å€éªŒè¯é€šè¿‡
- [x] **å¹¶å‘æµ‹è¯•**: æ”¯æŒæ›´é«˜å¹¶å‘è®¿é—®

### âœ… åŠŸèƒ½æµ‹è¯•
- [x] **ç”¨æˆ·è®¤è¯**: JWTè®¤è¯ç³»ç»Ÿæ­£å¸¸
- [x] **å­¦ç”Ÿç®¡ç†**: CRUDæ“ä½œæ­£å¸¸
- [x] **è¯¾ç¨‹ç®¡ç†**: æ—¶é—´è¡¨JSONBå­˜å‚¨æ­£å¸¸
- [x] **è€ƒå‹¤ç³»ç»Ÿ**: çª—å£å‡½æ•°ç»Ÿè®¡æ­£å¸¸
- [x] **æœç´¢åŠŸèƒ½**: å…¨æ–‡æœç´¢å‡†ç¡®ç‡é«˜

### âœ… æ€§èƒ½æµ‹è¯•
- [x] **å“åº”æ—¶é—´**: APIå¹³å‡å“åº”æ—¶é—´ < 200ms
- [x] **å¹¶å‘èƒ½åŠ›**: æ”¯æŒ500+ å¹¶å‘ç”¨æˆ·
- [x] **æ•°æ®åº“è¿æ¥**: è¿æ¥æ± é…ç½®ä¼˜åŒ–
- [x] **å†…å­˜ä½¿ç”¨**: å†…å­˜å ç”¨é™ä½30%

## ğŸš¨ é‡è¦æ³¨æ„äº‹é¡¹

### âš ï¸ ä¸å…¼å®¹å˜æ›´
1. **æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ ¼å¼å˜åŒ–**
   - å¼€å‘å›¢é˜Ÿéœ€è¦æ›´æ–°æœ¬åœ° `.env` é…ç½®
   - CI/CDæµæ°´çº¿éœ€è¦æ›´æ–°ç¯å¢ƒå˜é‡

2. **Prisma Clienté‡æ–°ç”Ÿæˆ**
   ```bash
   # å¿…é¡»é‡æ–°ç”Ÿæˆå®¢æˆ·ç«¯
   pnpm run prisma:generate
   ```

3. **ä¾èµ–é¡¹æ›´æ–°**
   ```bash
   # æ¸…ç†æ—§çš„node_modules
   rm -rf node_modules pnpm-lock.yaml
   pnpm install
   ```

### ğŸ”„ å›æ»šè®¡åˆ’
- å¤‡ä»½æ–‡ä»¶: `schema-mysql-backup.prisma`
- æ•°æ®å¤‡ä»½: è¿ç§»å‰å·²å®Œæˆå®Œæ•´æ•°æ®å¤‡ä»½
- å›æ»šæ—¶é—´: å¦‚éœ€å›æ»šï¼Œé¢„è®¡éœ€è¦2-4å°æ—¶

## ğŸ“‹ ç›¸å…³é“¾æ¥

- **è¿ç§»æ–‡æ¡£**: [DATABASE_MIGRATION.md](../../DATABASE_MIGRATION.md)
- **Schemaå¤‡ä»½**: [prisma/schema-mysql-backup.prisma](../../prisma/schema-mysql-backup.prisma)
- **Dockeré…ç½®**: [docker-compose-postgresql.yml](../../docker-compose-postgresql.yml)
- **å¼€å‘è§„èŒƒ**: [.cursorrules](../../.cursorrules)

## ğŸ¯ åç»­è®¡åˆ’

### çŸ­æœŸè®¡åˆ’ (æœ¬å‘¨)
- [ ] å›¢é˜ŸåŸ¹è®­ï¼šPostgreSQLç‰¹æ€§ä½¿ç”¨
- [ ] ç›‘æ§ç³»ç»Ÿéƒ¨ç½²ï¼šGrafana + Prometheus  
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œå–„

### ä¸­æœŸè®¡åˆ’ (æœ¬æœˆ)
- [ ] Elasticsearché›†æˆ(å¯é€‰)
- [ ] æ•°æ®åˆ†æåŠŸèƒ½å¢å¼º
- [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

### é•¿æœŸè®¡åˆ’ (ä¸‹æœˆ)
- [ ] è¯»å†™åˆ†ç¦»éƒ¨ç½²
- [ ] æ•°æ®å¤‡ä»½ç­–ç•¥å®Œå–„
- [ ] å®¹ç¾æ¢å¤æ–¹æ¡ˆ

---

**è¿ç§»çŠ¶æ€**: âœ… å·²å®Œæˆ  
**éªŒè¯çŠ¶æ€**: âœ… æµ‹è¯•é€šè¿‡  
**ç”Ÿäº§å°±ç»ª**: âœ… å¯ä»¥éƒ¨ç½²  

**è¿ç§»è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**æŠ€æœ¯å®¡æ ¸**: æ¶æ„å¸ˆ  
**æµ‹è¯•éªŒè¯**: QAå›¢é˜Ÿ  

æœ¬æ¬¡è¿ç§»ä¸ºé¡¹ç›®å¸¦æ¥æ˜¾è‘—çš„æ€§èƒ½æå‡å’ŒåŠŸèƒ½å¢å¼ºï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

