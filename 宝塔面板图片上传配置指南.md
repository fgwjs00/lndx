# 🛠️ 宝塔面板图片上传问题解决指南

## 📋 问题现象
- 图片上传成功（后端返回200状态）
- 但是图片无法通过URL访问显示
- 前端显示图片加载失败

## 🔧 解决方案

### 1. **检查和创建上传目录**

登录服务器，执行以下命令：

```bash
# 检查目录是否存在
ls -la /www/wwwroot/lndx/backend/uploads/

# 如果不存在，创建目录
mkdir -p /www/wwwroot/lndx/backend/uploads/id-cards

# 设置正确的权限
chmod 755 /www/wwwroot/lndx/backend/uploads/
chmod 755 /www/wwwroot/lndx/backend/uploads/id-cards/
chown -R www:www /www/wwwroot/lndx/backend/uploads/
```

### 2. **配置Nginx静态文件服务**

在宝塔面板中：

#### 步骤1：打开网站设置
1. 登录宝塔面板
2. 点击「网站」
3. 找到您的域名（如：ln.tuojiayi.com）
4. 点击「设置」

#### 步骤2：修改Nginx配置
1. 点击「配置文件」标签
2. 在server块中添加以下配置：

```nginx
# 在 server { 块内添加：

# 静态文件服务配置
location /uploads/ {
    alias /www/wwwroot/lndx/backend/uploads/;
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
    autoindex off;
    
    # 支持图片格式
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 步骤3：重载Nginx
```bash
# 测试配置
nginx -t

# 重载配置
nginx -s reload
```

### 3. **检查防火墙和安全组**

确保以下端口开放：
- 80 (HTTP)
- 443 (HTTPS)
- 3000 (后端API，如果直接访问)

### 4. **验证配置**

#### 测试1：手动创建测试文件
```bash
# 创建测试图片文件
echo "test image" > /www/wwwroot/lndx/backend/uploads/id-cards/test.jpg

# 测试访问
curl -I http://ln.tuojiayi.com/uploads/id-cards/test.jpg
```

#### 测试2：检查实际上传的文件
```bash
# 查看最新上传的文件
ls -la /www/wwwroot/lndx/backend/uploads/id-cards/ | tail -5

# 检查文件权限
ls -la /www/wwwroot/lndx/backend/uploads/id-cards/idcard_*.jpg
```

### 5. **常见问题排查**

#### 问题1：403 Forbidden
```bash
# 检查SELinux（如果启用）
sestatus
# 如果启用，可能需要设置上下文
```

#### 问题2：404 Not Found  
- 检查Nginx配置中的alias路径是否正确
- 检查location匹配规则

#### 问题3：权限问题
```bash
# 重置权限
chown -R www:www /www/wwwroot/lndx/backend/uploads/
chmod -R 755 /www/wwwroot/lndx/backend/uploads/
```

## 🧪 完整测试流程

### 1. 上传测试
1. 前端尝试上传图片
2. 检查浏览器Network标签页，确认返回的URL
3. 直接在浏览器中访问该URL

### 2. 后端日志检查
```bash
# 查看PM2日志
pm2 logs backend --lines 20

# 查看Nginx访问日志
tail -f /www/wwwlogs/ln.tuojiayi.com.log

# 查看Nginx错误日志
tail -f /www/wwwlogs/ln.tuojiayi.com.error.log
```

### 3. 系统资源检查
```bash
# 检查磁盘空间
df -h

# 检查内存使用
free -m

# 检查进程状态
pm2 status
```

## 📞 如果仍有问题

提供以下信息：
1. 浏览器控制台的完整错误信息
2. PM2日志：`pm2 logs backend --lines 50`
3. Nginx错误日志：`tail -20 /www/wwwlogs/域名.error.log`
4. 上传目录权限：`ls -la /www/wwwroot/lndx/backend/uploads/`
