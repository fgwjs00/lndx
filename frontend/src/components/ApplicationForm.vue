<template>
  <div class="application-form">
    <!-- Ë°®ÂçïÂ§¥ÈÉ® -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl p-8 text-white mb-8 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold mb-2">Â≠¶ÂëòÊä•ÂêçÁôªËÆ∞</h1>
          <p class="text-blue-100">ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊä•Âêç‰ø°ÊÅØÔºåÂ∏¶*‰∏∫ÂøÖÂ°´È°π</p>
        </div>
        <div class="text-6xl opacity-20">
          üìù
        </div>
      </div>
    </div>

    <!-- Êä•ÂêçË°®Âçï -->
    <div class="bg-white rounded-2xl shadow-lg p-8">
      <a-form
        ref="formRef"
        :model="formData"
        :rules="formRules"
        layout="vertical"
        @finish="handleSubmit"
        @finish-failed="handleSubmitFailed"
      >
        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-user text-blue-500 mr-3"></i>
            Âü∫Êú¨‰ø°ÊÅØ
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- ÂßìÂêç -->
            <a-form-item label="ÂßìÂêç" name="name" required>
              <a-input
                v-model:value="formData.name"
                placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç"
                size="large"
                :maxlength="20"
              />
            </a-form-item>

            <!-- ÊÄßÂà´ -->
            <a-form-item label="ÊÄßÂà´" name="gender" required>
              <a-radio-group v-model:value="formData.gender" size="large">
                <a-radio value="Áî∑">Áî∑</a-radio>
                <a-radio value="Â•≥">Â•≥</a-radio>
              </a-radio-group>
            </a-form-item>

            <!-- Âá∫ÁîüÂπ¥Êúà -->
            <a-form-item label="Âá∫ÁîüÂπ¥Êúà" name="birthDate" required>
              <a-date-picker
                v-model:value="formData.birthDate"
                placeholder="ÈÄâÊã©Âá∫ÁîüÊó•Êúü"
                size="large"
                style="width: 100%"
                :disabled-date="disabledDate"
              />
            </a-form-item>

            <!-- Ê∞ëÊóè -->
            <a-form-item label="Ê∞ëÊóè" name="ethnicity" required>
              <a-select
                v-model:value="formData.ethnicity"
                placeholder="ËØ∑ÈÄâÊã©Ê∞ëÊóè"
                size="large"
                :options="ethnicityOptions"
              />
            </a-form-item>

            <!-- ÊñáÂåñÁ®ãÂ∫¶ -->
            <a-form-item label="ÊñáÂåñÁ®ãÂ∫¶" name="educationLevel" required>
              <a-select
                v-model:value="formData.educationLevel"
                placeholder="ËØ∑ÈÄâÊã©ÊñáÂåñÁ®ãÂ∫¶"
                size="large"
                :options="educationOptions"
              />
            </a-form-item>

            <!-- ÊîøÊ≤ªÈù¢Ë≤å -->
            <a-form-item label="ÊîøÊ≤ªÈù¢Ë≤å" name="politicalStatus" required>
              <a-select
                v-model:value="formData.politicalStatus"
                placeholder="ËØ∑ÈÄâÊã©ÊîøÊ≤ªÈù¢Ë≤å"
                size="large"
                :options="politicalStatusOptions"
              />
            </a-form-item>

            <!-- Ë∫´‰ªΩËØÅÂè∑ -->
            <a-form-item label="Ë∫´‰ªΩËØÅÂè∑" name="idNumber" required>
              <a-input
                v-model:value="formData.idNumber"
                placeholder="ËØ∑ËæìÂÖ•18‰ΩçË∫´‰ªΩËØÅÂè∑"
                size="large"
                :maxlength="18"
                @blur="handleIdNumberBlur"
              />
            </a-form-item>

            <!-- ÂÅ•Â∫∑Áä∂ÂÜµ -->
            <a-form-item label="ÂÅ•Â∫∑Áä∂ÂÜµ" name="healthStatus" required>
              <a-select
                v-model:value="formData.healthStatus"
                placeholder="ËØ∑ÈÄâÊã©ÂÅ•Â∫∑Áä∂ÂÜµ"
                size="large"
                :options="healthStatusOptions"
              />
            </a-form-item>
          </div>
        </div>

        <!-- Â≠¶Á±ç‰ø°ÊÅØ -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-graduation-cap text-green-500 mr-3"></i>
            Â≠¶Á±ç‰ø°ÊÅØ
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- ÊòØÂê¶Âú®ËÅå -->
            <a-form-item label="ÊòØÂê¶Âú®ËÅå" name="isRetired" required>
              <a-radio-group v-model:value="formData.isRetired" size="large">
                <a-radio :value="false">Âú®ËÅå</a-radio>
                <a-radio :value="true">ÈÄÄ‰ºë</a-radio>
              </a-radio-group>
            </a-form-item>

            <!-- ‰øùÈô©Á±ªÂà´ -->
            <a-form-item label="‰øùÈô©Á±ªÂà´" name="retirementCategory" required>
              <a-select
                v-model:value="formData.retirementCategory"
                placeholder="ËØ∑ÈÄâÊã©‰øùÈô©Á±ªÂà´"
                size="large"
                :options="retirementCategoryOptions"
              />
            </a-form-item>

            <!-- ÊâÄÊä•‰∏ì‰∏ö -->
            <a-form-item label="ÊâÄÊä•‰∏ì‰∏ö" name="major" required>
              <a-select
                v-model:value="formData.major"
                placeholder="ËØ∑ÈÄâÊã©Êä•Âêç‰∏ì‰∏ö"
                size="large"
                :options="majorOptions"
                :loading="coursesLoading"
              />
            </a-form-item>

            <!-- ‰øùÈô©ÊúâÊïàÊúü -->
            <a-form-item label="‰øùÈô©ÊúâÊïàÊúü" name="studyPeriod" required>
              <a-date-picker
                v-model:value="formData.studyPeriod"
                placeholder="ÈÄâÊã©ÊúâÊïàÊúü"
                size="large"
                style="width: 100%"
              />
            </a-form-item>

            <!-- Â≠¶ÂëòËØÅÂè∑ -->
            <a-form-item label="Â≠¶ÂëòËØÅÂè∑" name="studentId">
              <a-input
                v-model:value="formData.studentId"
                placeholder="Ëá™Âä®ÁîüÊàêÊàñÊâãÂä®ËæìÂÖ•"
                size="large"
                :maxlength="20"
              />
            </a-form-item>

            <!-- ÊòØÂê¶Á≠æËÆ¢Ë∂ÖÈæÑÂçèËÆÆ -->
            <a-form-item label="ÊòØÂê¶Á≠æËÆ¢Ë∂ÖÈæÑÂçèËÆÆ" name="agreementSigned" required>
              <a-radio-group v-model:value="formData.agreementSigned" size="large">
                <a-radio :value="true">ÊòØ</a-radio>
                <a-radio :value="false">Âê¶</a-radio>
              </a-radio-group>
            </a-form-item>
          </div>
        </div>

        <!-- ËÅîÁ≥ª‰ø°ÊÅØ -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-phone text-orange-500 mr-3"></i>
            ËÅîÁ≥ª‰ø°ÊÅØ
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ÂÆ∂Â∫≠‰ΩèÂùÄ -->
            <a-form-item label="ÂÆ∂Â∫≠‰ΩèÂùÄ" name="familyAddress" required>
              <a-textarea
                v-model:value="formData.familyAddress"
                placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÂÆ∂Â∫≠‰ΩèÂùÄ"
                :rows="3"
                :maxlength="200"
                show-count
              />
            </a-form-item>

            <!-- ËÅîÁ≥ªÁîµËØù -->
            <a-form-item label="ËÅîÁ≥ªÁîµËØù" name="familyPhone" required>
              <a-input
                v-model:value="formData.familyPhone"
                placeholder="ËØ∑ËæìÂÖ•ËÅîÁ≥ªÁîµËØù"
                size="large"
                :maxlength="20"
              />
            </a-form-item>

            <!-- ÂÆ∂Â±ûÂßìÂêç -->
            <a-form-item label="ÂÆ∂Â±ûÂßìÂêç" name="emergencyContact" required>
              <a-input
                v-model:value="formData.emergencyContact"
                placeholder="ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÂßìÂêç"
                size="large"
                :maxlength="20"
              />
            </a-form-item>

            <!-- ÂÆ∂Â±ûËÅîÁ≥ªÁîµËØù -->
            <a-form-item label="ÂÆ∂Â±ûËÅîÁ≥ªÁîµËØù" name="emergencyPhone" required>
              <a-input
                v-model:value="formData.emergencyPhone"
                placeholder="ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÁîµËØù"
                size="large"
                :maxlength="20"
              />
            </a-form-item>
          </div>
        </div>

        <!-- ÁÖßÁâá‰∏ä‰º† -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-camera text-purple-500 mr-3"></i>
            ÁÖßÁâá‰∏ä‰º†
          </h3>
          
          <a-form-item label="Â≠¶ÂëòÁÖßÁâá" name="photo">
            <div class="flex items-center space-x-6">
              <!-- ÁÖßÁâáÈ¢ÑËßà -->
              <div class="w-32 h-40 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-50">
                <img
                  v-if="formData.photo"
                  :src="formData.photo"
                  alt="Â≠¶ÂëòÁÖßÁâá"
                  class="w-full h-full object-cover rounded-lg"
                />
                <div v-else class="text-center text-gray-400">
                  <i class="fas fa-user text-4xl mb-2"></i>
                  <p class="text-sm">Â≠¶ÂëòÁÖßÁâá</p>
                </div>
              </div>
              
              <!-- ‰∏ä‰º†ÊåâÈíÆ -->
              <div>
                <a-upload
                  :file-list="[]"
                  :before-upload="handlePhotoUpload"
                  accept="image/*"
                  :show-upload-list="false"
                >
                  <a-button type="primary" size="large" :loading="photoUploading">
                    <i class="fas fa-upload mr-2"></i>
                    {{ photoUploading ? '‰∏ä‰º†‰∏≠...' : 'ÈÄâÊã©ÁÖßÁâá' }}
                  </a-button>
                </a-upload>
                
                <div class="mt-2 text-sm text-gray-500">
                  <p>ÊîØÊåÅ JPG„ÄÅPNG Ê†ºÂºè</p>
                  <p>Êñá‰ª∂Â§ßÂ∞è‰∏çË∂ÖËøá 2MB</p>
                </div>
                
                <!-- ‰∏ä‰º†ËøõÂ∫¶ -->
                <div v-if="photoUploading && uploadProgress > 0" class="mt-2">
                  <a-progress :percent="uploadProgress" size="small" />
                </div>
              </div>
            </div>
          </a-form-item>
        </div>

        <!-- Â§áÊ≥®‰ø°ÊÅØ -->
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-sticky-note text-yellow-500 mr-3"></i>
            Â§áÊ≥®‰ø°ÊÅØ
          </h3>
          
          <a-form-item label="Â§áÊ≥®" name="remarks">
            <a-textarea
              v-model:value="formData.remarks"
              placeholder="ËØ∑ËæìÂÖ•ÂÖ∂‰ªñÈúÄË¶ÅËØ¥ÊòéÁöÑ‰ø°ÊÅØ"
              :rows="4"
              :maxlength="500"
              show-count
            />
          </a-form-item>
        </div>

        <!-- Êèê‰∫§ÊåâÈíÆ -->
        <div class="flex justify-center space-x-4">
          <a-button size="large" @click="handleReset">
            <i class="fas fa-undo mr-2"></i>
            ÈáçÁΩÆË°®Âçï
          </a-button>
          
          <a-button 
            type="primary" 
            size="large" 
            html-type="submit"
            :loading="submitting"
          >
            <i class="fas fa-paper-plane mr-2"></i>
            {{ submitting ? 'Êèê‰∫§‰∏≠...' : 'Êèê‰∫§Êä•Âêç' }}
          </a-button>
        </div>
      </a-form>
    </div>
  </div>
</template>

<script setup lang="ts">
/**
 * Êä•ÂêçË°®ÂçïÁªÑ‰ª∂
 * @component ApplicationForm
 * @description Âü∫‰∫éËÄÅÂπ¥Â§ßÂ≠¶Êä•ÂêçË°®ÁöÑÂÆåÊï¥Êä•ÂêçË°®Âçï
 */
import { ref, reactive, onMounted } from 'vue'
import { message } from 'ant-design-vue'
import dayjs, { type Dayjs } from 'dayjs'
import ApplicationService from '@/api/application'
import type { StudentInfo } from '@/types'

// Ë°®ÂçïÂºïÁî®
const formRef = ref()

// Ë°®ÂçïÊï∞ÊçÆ
const formData = reactive<Partial<StudentInfo>>({
  name: '',
  gender: 'Áî∑',
  birthDate: '',
  ethnicity: '',
  healthStatus: '',
  educationLevel: '',
  politicalStatus: '',
  idNumber: '',
  isRetired: false,
  retirementCategory: '',
  major: '',
  studyPeriod: '',
  studentId: '',
  agreementSigned: false,
  familyAddress: '',
  familyPhone: '',
  emergencyContact: '',
  emergencyPhone: '',
  photo: '',
  remarks: ''
})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const formRules = {
  name: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÂßìÂêç', trigger: 'blur' },
    { min: 2, max: 20, message: 'ÂßìÂêçÈïøÂ∫¶Âú®2-20‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  gender: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊÄßÂà´', trigger: 'change' }
  ],
  birthDate: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Âá∫ÁîüÊó•Êúü', trigger: 'change' }
  ],
  ethnicity: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Ê∞ëÊóè', trigger: 'change' }
  ],
  healthStatus: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÂÅ•Â∫∑Áä∂ÂÜµ', trigger: 'change' }
  ],
  educationLevel: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊñáÂåñÁ®ãÂ∫¶', trigger: 'change' }
  ],
  politicalStatus: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊîøÊ≤ªÈù¢Ë≤å', trigger: 'change' }
  ],
  idNumber: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑', trigger: 'blur' },
    { pattern: /^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$/, message: 'Ë∫´‰ªΩËØÅÂè∑Ê†ºÂºè‰∏çÊ≠£Á°Æ', trigger: 'blur' }
  ],
  isRetired: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊòØÂê¶Âú®ËÅå', trigger: 'change' }
  ],
  retirementCategory: [
    { required: true, message: 'ËØ∑ÈÄâÊã©‰øùÈô©Á±ªÂà´', trigger: 'change' }
  ],
  major: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Êä•Âêç‰∏ì‰∏ö', trigger: 'change' }
  ],
  studyPeriod: [
    { required: true, message: 'ËØ∑ÈÄâÊã©‰øùÈô©ÊúâÊïàÊúü', trigger: 'change' }
  ],
  agreementSigned: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊòØÂê¶Á≠æËÆ¢Ë∂ÖÈæÑÂçèËÆÆ', trigger: 'change' }
  ],
  familyAddress: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÂÆ∂Â∫≠‰ΩèÂùÄ', trigger: 'blur' },
    { min: 5, max: 200, message: 'Âú∞ÂùÄÈïøÂ∫¶Âú®5-200‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  familyPhone: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ËÅîÁ≥ªÁîµËØù', trigger: 'blur' },
    { pattern: /^1[3-9]\d{9}$/, message: 'ÊâãÊú∫Âè∑Ê†ºÂºè‰∏çÊ≠£Á°Æ', trigger: 'blur' }
  ],
  emergencyContact: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÂßìÂêç', trigger: 'blur' },
    { min: 2, max: 20, message: 'ÂßìÂêçÈïøÂ∫¶Âú®2-20‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  emergencyPhone: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÁîµËØù', trigger: 'blur' },
    { pattern: /^1[3-9]\d{9}$/, message: 'ÊâãÊú∫Âè∑Ê†ºÂºè‰∏çÊ≠£Á°Æ', trigger: 'blur' }
  ]
}

// ÈÄâÈ°πÊï∞ÊçÆ
const ethnicityOptions = [
  { label: 'Ê±âÊóè', value: 'Ê±âÊóè' },
  { label: 'ËíôÂè§Êóè', value: 'ËíôÂè§Êóè' },
  { label: 'ÂõûÊóè', value: 'ÂõûÊóè' },
  { label: 'ËóèÊóè', value: 'ËóèÊóè' },
  { label: 'Áª¥ÂêæÂ∞îÊóè', value: 'Áª¥ÂêæÂ∞îÊóè' },
  { label: 'ËãóÊóè', value: 'ËãóÊóè' },
  { label: 'ÂΩùÊóè', value: 'ÂΩùÊóè' },
  { label: 'Â£ÆÊóè', value: 'Â£ÆÊóè' },
  { label: 'Â∏É‰æùÊóè', value: 'Â∏É‰æùÊóè' },
  { label: 'ÊúùÈ≤úÊóè', value: 'ÊúùÈ≤úÊóè' },
  { label: 'Êª°Êóè', value: 'Êª°Êóè' },
  { label: '‰æóÊóè', value: '‰æóÊóè' },
  { label: 'Áë∂Êóè', value: 'Áë∂Êóè' },
  { label: 'ÁôΩÊóè', value: 'ÁôΩÊóè' },
  { label: 'ÂúüÂÆ∂Êóè', value: 'ÂúüÂÆ∂Êóè' },
  { label: 'ÂìàÂ∞ºÊóè', value: 'ÂìàÂ∞ºÊóè' },
  { label: 'ÂìàËê®ÂÖãÊóè', value: 'ÂìàËê®ÂÖãÊóè' },
  { label: 'ÂÇ£Êóè', value: 'ÂÇ£Êóè' },
  { label: 'ÈªéÊóè', value: 'ÈªéÊóè' },
  { label: 'ÂÇàÂÉ≥Êóè', value: 'ÂÇàÂÉ≥Êóè' },
  { label: '‰Ω§Êóè', value: '‰Ω§Êóè' },
  { label: 'Áï≤Êóè', value: 'Áï≤Êóè' },
  { label: 'È´òÂ±±Êóè', value: 'È´òÂ±±Êóè' },
  { label: 'ÊãâÁ•úÊóè', value: 'ÊãâÁ•úÊóè' },
  { label: 'Ê∞¥Êóè', value: 'Ê∞¥Êóè' },
  { label: '‰∏ú‰π°Êóè', value: '‰∏ú‰π°Êóè' },
  { label: 'Á∫≥Ë•øÊóè', value: 'Á∫≥Ë•øÊóè' },
  { label: 'ÊôØÈ¢áÊóè', value: 'ÊôØÈ¢áÊóè' },
  { label: 'ÊüØÂ∞îÂÖãÂ≠úÊóè', value: 'ÊüØÂ∞îÂÖãÂ≠úÊóè' },
  { label: 'ÂúüÊóè', value: 'ÂúüÊóè' },
  { label: 'ËææÊñ°Â∞îÊóè', value: 'ËææÊñ°Â∞îÊóè' },
  { label: '‰ª´‰Ω¨Êóè', value: '‰ª´‰Ω¨Êóè' },
  { label: 'ÁæåÊóè', value: 'ÁæåÊóè' },
  { label: 'Â∏ÉÊúóÊóè', value: 'Â∏ÉÊúóÊóè' },
  { label: 'ÊííÊãâÊóè', value: 'ÊííÊãâÊóè' },
  { label: 'ÊØõÂçóÊóè', value: 'ÊØõÂçóÊóè' },
  { label: '‰ª°‰Ω¨Êóè', value: '‰ª°‰Ω¨Êóè' },
  { label: 'Èî°‰ºØÊóè', value: 'Èî°‰ºØÊóè' },
  { label: 'ÈòøÊòåÊóè', value: 'ÈòøÊòåÊóè' },
  { label: 'ÊôÆÁ±≥Êóè', value: 'ÊôÆÁ±≥Êóè' },
  { label: 'Â°îÂêâÂÖãÊóè', value: 'Â°îÂêâÂÖãÊóè' },
  { label: 'ÊÄíÊóè', value: 'ÊÄíÊóè' },
  { label: '‰πåÂ≠úÂà´ÂÖãÊóè', value: '‰πåÂ≠úÂà´ÂÖãÊóè' },
  { label: '‰øÑÁΩóÊñØÊóè', value: '‰øÑÁΩóÊñØÊóè' },
  { label: 'ÈÑÇÊ∏©ÂÖãÊóè', value: 'ÈÑÇÊ∏©ÂÖãÊóè' },
  { label: 'Âæ∑ÊòÇÊóè', value: 'Âæ∑ÊòÇÊóè' },
  { label: '‰øùÂÆâÊóè', value: '‰øùÂÆâÊóè' },
  { label: 'Ë£ïÂõ∫Êóè', value: 'Ë£ïÂõ∫Êóè' },
  { label: '‰∫¨Êóè', value: '‰∫¨Êóè' },
  { label: 'Â°îÂ°îÂ∞îÊóè', value: 'Â°îÂ°îÂ∞îÊóè' },
  { label: 'Áã¨ÈæôÊóè', value: 'Áã¨ÈæôÊóè' },
  { label: 'ÈÑÇ‰º¶Êò•Êóè', value: 'ÈÑÇ‰º¶Êò•Êóè' },
  { label: 'Ëµ´Âì≤Êóè', value: 'Ëµ´Âì≤Êóè' },
  { label: 'Èó®Â∑¥Êóè', value: 'Èó®Â∑¥Êóè' },
  { label: 'ÁèûÂ∑¥Êóè', value: 'ÁèûÂ∑¥Êóè' },
  { label: 'Âü∫ËØ∫Êóè', value: 'Âü∫ËØ∫Êóè' }
]

const educationOptions = [
  { label: 'Â∞èÂ≠¶', value: 'Â∞èÂ≠¶' },
  { label: 'Âàù‰∏≠', value: 'Âàù‰∏≠' },
  { label: 'È´ò‰∏≠', value: 'È´ò‰∏≠' },
  { label: '‰∏≠‰∏ì', value: '‰∏≠‰∏ì' },
  { label: 'Â§ß‰∏ì', value: 'Â§ß‰∏ì' },
  { label: 'Êú¨Áßë', value: 'Êú¨Áßë' },
  { label: 'Á†îÁ©∂Áîü', value: 'Á†îÁ©∂Áîü' },
  { label: 'ÂçöÂ£´', value: 'ÂçöÂ£´' }
]

const politicalStatusOptions = [
  { label: 'Áæ§‰ºó', value: 'Áæ§‰ºó' },
  { label: 'ÂÖ±ÈùíÂõ¢Âëò', value: 'ÂÖ±ÈùíÂõ¢Âëò' },
  { label: '‰∏≠ÂÖ±ÂÖöÂëò', value: '‰∏≠ÂÖ±ÂÖöÂëò' },
  { label: '‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò', value: '‰∏≠ÂÖ±È¢ÑÂ§áÂÖöÂëò' },
  { label: 'Ê∞ëÈù©ÂÖöÂëò', value: 'Ê∞ëÈù©ÂÖöÂëò' },
  { label: 'Ê∞ëÁõüÁõüÂëò', value: 'Ê∞ëÁõüÁõüÂëò' },
  { label: 'Ê∞ëÂª∫‰ºöÂëò', value: 'Ê∞ëÂª∫‰ºöÂëò' },
  { label: 'Ê∞ëËøõ‰ºöÂëò', value: 'Ê∞ëËøõ‰ºöÂëò' },
  { label: 'ÂÜúÂ∑•ÂÖöÂÖöÂëò', value: 'ÂÜúÂ∑•ÂÖöÂÖöÂëò' },
  { label: 'Ëá¥ÂÖ¨ÂÖöÂÖöÂëò', value: 'Ëá¥ÂÖ¨ÂÖöÂÖöÂëò' },
  { label: '‰πù‰∏âÂ≠¶Á§æÁ§æÂëò', value: '‰πù‰∏âÂ≠¶Á§æÁ§æÂëò' },
  { label: 'Âè∞ÁõüÁõüÂëò', value: 'Âè∞ÁõüÁõüÂëò' },
  { label: 'Êó†ÂÖöÊ¥æ‰∫∫Â£´', value: 'Êó†ÂÖöÊ¥æ‰∫∫Â£´' }
]

const healthStatusOptions = [
  { label: 'ÂÅ•Â∫∑', value: 'ÂÅ•Â∫∑' },
  { label: 'ËâØÂ•Ω', value: 'ËâØÂ•Ω' },
  { label: '‰∏ÄËà¨', value: '‰∏ÄËà¨' },
  { label: 'ËæÉÂ∑Æ', value: 'ËæÉÂ∑Æ' }
]

const retirementCategoryOptions = [
  { label: '‰ºÅ‰∏öËÅåÂ∑•Âü∫Êú¨ÂÖªËÄÅ‰øùÈô©', value: '‰ºÅ‰∏öËÅåÂ∑•Âü∫Êú¨ÂÖªËÄÅ‰øùÈô©' },
  { label: 'Êú∫ÂÖ≥‰∫ã‰∏öÂçï‰ΩçÂÖªËÄÅ‰øùÈô©', value: 'Êú∫ÂÖ≥‰∫ã‰∏öÂçï‰ΩçÂÖªËÄÅ‰øùÈô©' },
  { label: 'Âüé‰π°Â±ÖÊ∞ëÂü∫Êú¨ÂÖªËÄÅ‰øùÈô©', value: 'Âüé‰π°Â±ÖÊ∞ëÂü∫Êú¨ÂÖªËÄÅ‰øùÈô©' },
  { label: 'ÂÖ∂‰ªñ', value: 'ÂÖ∂‰ªñ' }
]

// ‰∏ì‰∏öÈÄâÈ°πÔºà‰ªéAPIËé∑ÂèñÔºâ
const majorOptions = ref<Array<{ label: string; value: string }>>([])
const coursesLoading = ref(false)

// Áä∂ÊÄÅÂèòÈáè
const submitting = ref(false)
const photoUploading = ref(false)
const uploadProgress = ref(0)

/**
 * Á¶ÅÁî®Êú™Êù•Êó•Êúü
 */
const disabledDate = (current: Dayjs): boolean => {
  return current && current > dayjs().endOf('day')
}

/**
 * Â§ÑÁêÜË∫´‰ªΩËØÅÂè∑Â§±ÁÑ¶‰∫ã‰ª∂
 */
const handleIdNumberBlur = async (): Promise<void> => {
  if (formData.idNumber && formData.idNumber.length === 18) {
    try {
      const response = await ApplicationService.checkIdNumberExists(formData.idNumber)
      if (response.data.exists) {
        message.warning('ËØ•Ë∫´‰ªΩËØÅÂè∑Â∑≤Â≠òÂú®Êä•ÂêçËÆ∞ÂΩï')
      }
    } catch (error) {
      console.error('Ê£ÄÊü•Ë∫´‰ªΩËØÅÂè∑Â§±Ë¥•:', error)
    }
  }
}

/**
 * Â§ÑÁêÜÁÖßÁâá‰∏ä‰º†
 */
const handlePhotoUpload = async (file: File): Promise<boolean> => {
  // È™åËØÅÊñá‰ª∂Á±ªÂûã
  if (!file.type.startsWith('image/')) {
    message.error('Âè™ËÉΩ‰∏ä‰º†ÂõæÁâáÊñá‰ª∂')
    return false
  }

  // È™åËØÅÊñá‰ª∂Â§ßÂ∞è
  if (file.size > 2 * 1024 * 1024) {
    message.error('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá2MB')
    return false
  }

  try {
    photoUploading.value = true
    uploadProgress.value = 0

    const response = await ApplicationService.uploadStudentPhoto(file, (progress) => {
      uploadProgress.value = progress
    })

    if (response.code === 200) {
      formData.photo = response.data.url
      message.success('ÁÖßÁâá‰∏ä‰º†ÊàêÂäü')
    } else {
      message.error(response.message || 'ÁÖßÁâá‰∏ä‰º†Â§±Ë¥•')
    }
  } catch (error) {
    console.error('ÁÖßÁâá‰∏ä‰º†Â§±Ë¥•:', error)
    message.error('ÁÖßÁâá‰∏ä‰º†Â§±Ë¥•')
  } finally {
    photoUploading.value = false
    uploadProgress.value = 0
  }

  return false // ÈòªÊ≠¢ÈªòËÆ§‰∏ä‰º†Ë°å‰∏∫
}

/**
 * Â§ÑÁêÜË°®ÂçïÊèê‰∫§
 */
const handleSubmit = async (values: any): Promise<void> => {
  try {
    submitting.value = true

    // ËΩ¨Êç¢Êó•ÊúüÊ†ºÂºè
    const submitData = {
      ...values,
      birthDate: values.birthDate ? dayjs(values.birthDate).format('YYYY-MM-DD') : '',
      studyPeriod: values.studyPeriod ? dayjs(values.studyPeriod).format('YYYY-MM-DD') : '',
      applicationDate: new Date().toISOString(),
      status: 'pending' as const
    }

    const response = await ApplicationService.submitApplication(submitData, 1) // ÂÅáËÆæËØæÁ®ãID‰∏∫1

    if (response.code === 200) {
      message.success('Êä•ÂêçÊèê‰∫§ÊàêÂäüÔºåËØ∑Á≠âÂæÖÂÆ°Ê†∏')
      handleReset()
    } else {
      message.error(response.message || 'Êä•ÂêçÊèê‰∫§Â§±Ë¥•')
    }
  } catch (error) {
    console.error('Êèê‰∫§Â§±Ë¥•:', error)
    message.error('Êä•ÂêçÊèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    submitting.value = false
  }
}

/**
 * Â§ÑÁêÜË°®ÂçïÊèê‰∫§Â§±Ë¥•
 */
const handleSubmitFailed = (errorInfo: any): void => {
  console.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•:', errorInfo)
  message.error('ËØ∑Ê£ÄÊü•Ë°®Âçï‰ø°ÊÅØÊòØÂê¶Â°´ÂÜôÂÆåÊï¥')
}

/**
 * ÈáçÁΩÆË°®Âçï
 */
const handleReset = (): void => {
  formRef.value?.resetFields()
  Object.assign(formData, {
    name: '',
    gender: 'Áî∑',
    birthDate: '',
    ethnicity: '',
    healthStatus: '',
    educationLevel: '',
    politicalStatus: '',
    idNumber: '',
    isRetired: false,
    retirementCategory: '',
    major: '',
    studyPeriod: '',
    studentId: '',
    agreementSigned: false,
    familyAddress: '',
    familyPhone: '',
    emergencyContact: '',
    emergencyPhone: '',
    photo: '',
    remarks: ''
  })
}

/**
 * Ëé∑ÂèñÂèØÊä•ÂêçËØæÁ®ã
 */
const loadAvailableCourses = async (): Promise<void> => {
  try {
    coursesLoading.value = true
    const response = await ApplicationService.getAvailableCourses()
    
    if (response.code === 200) {
      majorOptions.value = response.data.map(course => ({
        label: course.name,
        value: course.name
      }))
    }
  } catch (error) {
    console.error('Ëé∑ÂèñËØæÁ®ãÂàóË°®Â§±Ë¥•:', error)
    message.error('Ëé∑ÂèñËØæÁ®ãÂàóË°®Â§±Ë¥•')
  } finally {
    coursesLoading.value = false
  }
}

/**
 * ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ
 */
onMounted((): void => {
  loadAvailableCourses()
})
</script>

<style scoped>
.application-form {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

:deep(.ant-form-item-label) {
  font-weight: 500;
  color: #374151;
}

:deep(.ant-input), 
:deep(.ant-select-selector), 
:deep(.ant-picker) {
  border-radius: 8px;
}

:deep(.ant-btn) {
  border-radius: 8px;
  font-weight: 500;
}

:deep(.ant-upload) {
  width: 100%;
}

:deep(.ant-progress-line) {
  margin-top: 8px;
}
</style> 