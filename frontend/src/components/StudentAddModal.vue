<template>
  <a-modal
    v-model:open="modalVisible"
    title="Ê∑ªÂä†Â≠¶Áîü"
    width="1200px"
    :footer="null"
    :maskClosable="false"
    :destroyOnClose="true"
    class="student-add-modal"
  >
    <div class="max-h-[80vh] overflow-y-auto">
      <a-form
        ref="formRef"
        :model="formData"
        :rules="formRules"
        layout="vertical"
        @finish="handleSubmit"
        @finish-failed="handleSubmitFailed"
      >
        <!-- Ë∫´‰ªΩËØÅËØªÂç°Âô® -->
        <div class="mb-6">
          <IdCardReader 
            @dataRead="handleIdCardDataRead"
            @error="handleReaderError"
          />
        </div>

        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
        <div class="mb-6">
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
              <i class="fas fa-user text-blue-500 mr-2"></i>
              Âü∫Êú¨‰ø°ÊÅØ
            </h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- ÂßìÂêç -->
            <a-form-item label="ÂßìÂêç" name="name" required>
              <a-input
                v-model:value="formData.name"
                placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç"
                :maxlength="20"
              />
            </a-form-item>

            <!-- ÊÄßÂà´ -->
            <a-form-item label="ÊÄßÂà´" name="gender" required>
              <a-radio-group v-model:value="formData.gender">
                <a-radio value="Áî∑">Áî∑</a-radio>
                <a-radio value="Â•≥">Â•≥</a-radio>
              </a-radio-group>
            </a-form-item>

            <!-- Âá∫ÁîüÂπ¥Êúà -->
            <a-form-item label="Âá∫ÁîüÂπ¥Êúà" name="birthDate" required>
              <a-date-picker
                v-model:value="formData.birthDate"
                placeholder="Â∞Ü‰ªéË∫´‰ªΩËØÅÂè∑Á†ÅËá™Âä®ÊèêÂèñ"
                style="width: 100%"
                format="YYYY-MM-DD"
                disabled
                :allow-clear="false"
              />
              <div class="text-xs text-gray-500 mt-1">üí° Âá∫ÁîüÊó•ÊúüÂ∞ÜÊ†πÊçÆË∫´‰ªΩËØÅÂè∑Á†ÅËá™Âä®Â°´ÂÜô</div>
            </a-form-item>

            <!-- Ê∞ëÊóè -->
            <a-form-item label="Ê∞ëÊóè" name="ethnicity" required>
              <a-select
                v-model:value="formData.ethnicity"
                placeholder="ËØ∑ÈÄâÊã©Ê∞ëÊóè"
                :options="ethnicityOptions"
              />
            </a-form-item>

            <!-- ÊñáÂåñÁ®ãÂ∫¶ -->
            <a-form-item label="ÊñáÂåñÁ®ãÂ∫¶" name="educationLevel" required>
              <a-select
                v-model:value="formData.educationLevel"
                placeholder="ËØ∑ÈÄâÊã©ÊñáÂåñÁ®ãÂ∫¶"
                :options="educationOptions"
              />
            </a-form-item>

            <!-- ÊîøÊ≤ªÈù¢Ë≤å -->
            <a-form-item label="ÊîøÊ≤ªÈù¢Ë≤å" name="politicalStatus" required>
              <a-select
                v-model:value="formData.politicalStatus"
                placeholder="ËØ∑ÈÄâÊã©ÊîøÊ≤ªÈù¢Ë≤å"
                :options="politicalStatusOptions"
              />
            </a-form-item>

            <!-- ÂÅ•Â∫∑Áä∂ÂÜµ -->
            <a-form-item label="ÂÅ•Â∫∑Áä∂ÂÜµ" name="healthStatus" required>
              <a-select
                v-model:value="formData.healthStatus"
                placeholder="ËØ∑ÈÄâÊã©ÂÅ•Â∫∑Áä∂ÂÜµ"
                :options="healthOptions"
              />
            </a-form-item>

            <!-- Ë∫´‰ªΩËØÅÂè∑ -->
            <a-form-item label="Ë∫´‰ªΩËØÅÂè∑" name="idNumber" required>
              <a-input
                v-model:value="formData.idNumber"
                placeholder="ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑"
                :maxlength="18"
                @input="handleIdNumberInput"
              />
            </a-form-item>

            <!-- Ë∫´‰ªΩËØÅÂú∞ÂùÄ -->
            <a-form-item label="Ë∫´‰ªΩËØÅÂú∞ÂùÄ" name="idCardAddress" required>
              <a-input
                v-model:value="formData.idCardAddress"
                placeholder="Ë∫´‰ªΩËØÅ‰∏äÁöÑÂú∞ÂùÄ"
                :maxlength="100"
              />
            </a-form-item>

            <!-- ËÅîÁ≥ªÁîµËØù -->
            <a-form-item label="ËÅîÁ≥ªÁîµËØù" name="contactPhone" required>
              <a-input
                v-model:value="formData.contactPhone"
                placeholder="ËØ∑ËæìÂÖ•ËÅîÁ≥ªÁîµËØù"
                :maxlength="15"
              />
            </a-form-item>
          </div>
        </div>

        <!-- Ë∫´‰ªΩËØÅÁÖßÁâá -->
        <div class="mb-6">
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
              <i class="fas fa-id-card text-green-500 mr-2"></i>
              Ë∫´‰ªΩËØÅÁÖßÁâá
            </h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Ë∫´‰ªΩËØÅÊ≠£Èù¢ÁÖßÁâá -->
            <a-form-item label="Ë∫´‰ªΩËØÅÊ≠£Èù¢" name="idCardFront">
              <a-upload
                v-model:file-list="idCardFrontFileList"
                :before-upload="(file: any) => handleIdCardUpload(file, 'front')"
                :show-upload-list="false"
                accept="image/*"
                class="id-card-uploader"
              >
                <div class="id-card-upload-area">
                  <div v-if="formData.idCardFront || pendingPhotoData.idCardFront" class="relative">
                    <img 
                      :src="idCardFrontUrl" 
                      alt="Ë∫´‰ªΩËØÅÊ≠£Èù¢" 
                      class="id-card-image cursor-pointer" 
                      @click.stop="previewIdCard('front')"
                    />
                    <div class="absolute top-2 right-2 flex space-x-1">
                      <a-button 
                        type="primary" 
                        size="small"
                        @click.stop="clearIdCardPhoto('front')"
                        class="text-xs"
                      >
                        ÈáçÊñ∞‰∏ä‰º†
                      </a-button>
                    </div>
                  </div>
                  <div v-else class="upload-placeholder">
                    <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 font-medium">Ë∫´‰ªΩËØÅÊ≠£Èù¢</p>
                    <p class="text-xs text-gray-400">ÁÇπÂáª‰∏ä‰º†Êàñ‰ΩøÁî®ËØªÂç°Âô®</p>
                  </div>
                </div>
              </a-upload>
            </a-form-item>

            <!-- Ë∫´‰ªΩËØÅÂèçÈù¢ÁÖßÁâá -->
            <a-form-item label="Ë∫´‰ªΩËØÅÂèçÈù¢" name="idCardBack">
              <a-upload
                v-model:file-list="idCardBackFileList"
                :before-upload="(file: any) => handleIdCardUpload(file, 'back')"
                :show-upload-list="false"
                accept="image/*"
                class="id-card-uploader"
              >
                <div class="id-card-upload-area">
                  <div v-if="formData.idCardBack || pendingPhotoData.idCardBack" class="relative">
                    <img 
                      :src="idCardBackUrl" 
                      alt="Ë∫´‰ªΩËØÅÂèçÈù¢" 
                      class="id-card-image cursor-pointer" 
                      @click.stop="previewIdCard('back')"
                    />
                    <div class="absolute top-2 right-2 flex space-x-1">
                      <a-button 
                        type="primary" 
                        size="small"
                        @click.stop="clearIdCardPhoto('back')"
                        class="text-xs"
                      >
                        ÈáçÊñ∞‰∏ä‰º†
                      </a-button>
                    </div>
                  </div>
                  <div v-else class="upload-placeholder">
                    <i class="fas fa-id-card text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 font-medium">Ë∫´‰ªΩËØÅÂèçÈù¢</p>
                    <p class="text-xs text-gray-400">ÁÇπÂáª‰∏ä‰º†Êàñ‰ΩøÁî®ËØªÂç°Âô®</p>
                  </div>
                </div>
              </a-upload>
            </a-form-item>
          </div>
        </div>

        <!-- Â≠¶Á±ç‰ø°ÊÅØ -->
        <div class="mb-6">
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
              <i class="fas fa-graduation-cap text-green-500 mr-2"></i>
              Â≠¶Á±ç‰ø°ÊÅØ
            </h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Â≠¶ÂëòËØÅÂè∑ -->
            <a-form-item label="Â≠¶ÂëòËØÅÂè∑" name="studentId">
              <a-input
                v-model:value="formData.studentId"
                placeholder="Ëá™Âä®ÁîüÊàêÊàñÊâãÂä®ËæìÂÖ•"
                :maxlength="20"
              />
            </a-form-item>

            <!-- Â≠¶ÊúüÈÄâÊã© -->
            <a-form-item label="Â≠¶Êúü" name="semester" required>
              <a-select
                v-model:value="formData.semester"
                placeholder="ËØ∑ÈÄâÊã©Â≠¶Êúü"
                :options="semesterOptions"
                :loading="semestersLoading"
              />
            </a-form-item>

            <!-- ÊâÄÊä•ËØæÁ®ã -->
            <a-form-item label="ÊâÄÊä•ËØæÁ®ã" name="selectedCourses" required>
              <a-select
                v-model:value="formData.selectedCourses"
                mode="multiple"
                placeholder="ËØ∑ÈÄâÊã©ËØæÁ®ã"
                :options="courseOptions"
                :loading="coursesLoading"
                style="width: 100%"
              />
            </a-form-item>

            <!-- ‰øùÈô©ÂÖ¨Âè∏ -->
            <a-form-item label="‰øùÈô©ÂÖ¨Âè∏" name="insuranceCompany">
              <a-select
                v-model:value="formData.insuranceCompany"
                placeholder="ËØ∑ÈÄâÊã©‰øùÈô©ÂÖ¨Âè∏"
                :options="insuranceCompanyOptions"
              />
            </a-form-item>

            <!-- ‰øùÈô©Á±ªÂà´ -->
            <a-form-item label="‰øùÈô©Á±ªÂà´" name="retirementCategory">
              <a-select
                v-model:value="formData.retirementCategory"
                placeholder="ËØ∑ÈÄâÊã©‰øùÈô©Á±ªÂà´"
                :options="retirementCategoryOptions"
              />
            </a-form-item>

            <!-- ‰øùÈô©ÊúâÊïàÊúüÂºÄÂßã -->
            <a-form-item label="‰øùÈô©ÊúâÊïàÊúüÂºÄÂßã" name="studyPeriodStart">
              <a-date-picker
                v-model:value="formData.studyPeriodStart"
                placeholder="ÂºÄÂßãÊó•Êúü"
                style="width: 100%"
                format="YYYY-MM-DD"
                @change="handleInsuranceStartDateChange"
              />
            </a-form-item>

            <!-- ‰øùÈô©ÊúâÊïàÊúüÁªìÊùü -->
            <a-form-item label="‰øùÈô©ÊúâÊïàÊúüÁªìÊùü" name="studyPeriodEnd">
              <a-date-picker
                v-model:value="formData.studyPeriodEnd"
                placeholder="ÁªìÊùüÊó•Êúü"
                style="width: 100%"
                format="YYYY-MM-DD"
              />
            </a-form-item>

            <!-- ÊòØÂê¶Âú®ËÅå -->
            <a-form-item label="ÊòØÂê¶Âú®ËÅå" name="isRetired" required>
              <a-radio-group v-model:value="formData.isRetired">
                <a-radio :value="false">Âú®ËÅå</a-radio>
                <a-radio :value="true">ÈÄÄ‰ºë</a-radio>
              </a-radio-group>
            </a-form-item>

            <!-- ÊòØÂê¶Á≠æËÆ¢Ë∂ÖÈæÑÂçèËÆÆ -->
            <a-form-item label="ÊòØÂê¶Á≠æËÆ¢Ë∂ÖÈæÑÂçèËÆÆ" name="agreementSigned" required>
              <a-radio-group v-model:value="formData.agreementSigned">
                <a-radio :value="true">ÊòØ</a-radio>
                <a-radio :value="false">Âê¶</a-radio>
              </a-radio-group>
            </a-form-item>
          </div>
        </div>

        <!-- ËÅîÁ≥ª‰ø°ÊÅØ -->
        <div class="mb-6">
          <div class="mb-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center">
              <i class="fas fa-address-book text-purple-500 mr-2"></i>
              ËÅîÁ≥ª‰ø°ÊÅØ
            </h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ -->
            <a-form-item label="Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫" name="emergencyContact" required>
              <a-input
                v-model:value="formData.emergencyContact"
                placeholder="ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÂßìÂêç"
                :maxlength="20"
              />
            </a-form-item>

            <!-- Á¥ßÊÄ•ËÅîÁ≥ªÁîµËØù -->
            <a-form-item label="Á¥ßÊÄ•ËÅîÁ≥ªÁîµËØù" name="emergencyPhone" required>
              <a-input
                v-model:value="formData.emergencyPhone"
                placeholder="ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫ÁîµËØù"
                :maxlength="15"
              />
            </a-form-item>

            <!-- Áé∞Â±Ö‰ΩèÂú∞ÂùÄ -->
            <a-form-item label="Áé∞Â±Ö‰ΩèÂú∞ÂùÄ" name="familyAddress" required>
              <a-textarea
                v-model:value="formData.familyAddress"
                placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÁé∞Â±Ö‰ΩèÂú∞ÂùÄ"
                :rows="3"
                :maxlength="200"
                show-count
              />
            </a-form-item>

            <!-- ‰∏™‰∫∫ÁÖßÁâá -->
            <a-form-item label="‰∏™‰∫∫ÁÖßÁâá" name="photo">
              <a-upload
                v-model:file-list="fileList"
                :before-upload="handlePhotoUpload"
                :show-upload-list="false"
                accept="image/*"
                class="avatar-uploader"
              >
                <div class="upload-area">
                  <img v-if="formData.photo || pendingPhotoData.photo" :src="photoUrl" alt="Â§¥ÂÉè" class="uploaded-image" />
                  <div v-else class="upload-placeholder">
                    <i class="fas fa-camera text-2xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600">ÁÇπÂáª‰∏ä‰º†ÁÖßÁâá</p>
                    <p class="text-xs text-gray-400">ÊîØÊåÅJPG/PNGÊ†ºÂºèÔºå‰∏çË∂ÖËøá2MB</p>
                  </div>
                </div>
              </a-upload>
            </a-form-item>

            <!-- Â§áÊ≥® -->
            <a-form-item label="Â§áÊ≥®" name="remarks">
              <a-textarea
                v-model:value="formData.remarks"
                placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ"
                :rows="3"
                :maxlength="500"
                show-count
              />
            </a-form-item>
          </div>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
          <a-button @click="handleCancel" size="large">
            ÂèñÊ∂à
          </a-button>
          <a-button @click="handleReset" size="large">
            ÈáçÁΩÆË°®Âçï
          </a-button>
          <a-button
            type="primary"
            html-type="submit"
            :loading="submitting"
            size="large"
          >
            {{ submitting ? 'Ê∑ªÂä†‰∏≠...' : 'Ê∑ªÂä†Â≠¶Áîü' }}
          </a-button>
        </div>
      </a-form>
    </div>

    <!-- Ë∫´‰ªΩËØÅÁÖßÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <a-modal
      :open="previewVisible"
      :title="previewTitle"
      :footer="null"
      @cancel="handlePreviewCancel"
      centered
      width="600px"
      class="id-card-preview-modal"
    >
      <div class="preview-image-container">
        <img 
          :src="previewImage" 
          :alt="previewTitle"
          class="preview-image"
        />
      </div>
    </a-modal>
  </a-modal>
</template>

<script setup lang="ts">
/**
 * Ê∑ªÂä†Â≠¶ÁîüÂºπÁ™ó
 * @component StudentAddModal
 * @description Áõ¥Êé•Ê∑ªÂä†Â≠¶ÁîüÔºå‰∏çÁªèËøáÊä•ÂêçÂÆ°Ê†∏ÔºåÁªïËøáÊâÄÊúâÈôêÂà∂
 */
import { ref, reactive, computed, watch } from 'vue'
import { message } from 'ant-design-vue'
import { useAuthStore } from '@/store/auth'
import dayjs, { type Dayjs } from 'dayjs'
import type { IdCardData } from '@/types'
import IdCardReader from '@/components/IdCardReader.vue'
import ApplicationService from '@/api/application'
import { CourseService } from '@/api/course'
import { StudentService } from '@/api/student'

// Props
interface Props {
  open: boolean
}

// Emits
interface Emits {
  (e: 'update:open', value: boolean): void
  (e: 'success'): void
}

const props = defineProps<Props>()
const emit = defineEmits<Emits>()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const modalVisible = computed({
  get: () => props.open,
  set: (value) => emit('update:open', value)
})

const authStore = useAuthStore()
const formRef = ref()
const submitting = ref<boolean>(false)
const semestersLoading = ref<boolean>(false)
const coursesLoading = ref<boolean>(false)

// Ë°®ÂçïÊï∞ÊçÆÊé•Âè£
interface StudentFormData {
  name: string
  gender: string
  birthDate: string | Dayjs
  ethnicity: string
  healthStatus: string
  educationLevel: string
  politicalStatus: string
  phone: string
  idNumber: string
  idCardAddress: string
  contactPhone: string
  idCardFront: string
  idCardBack: string
  isRetired: boolean
  insuranceCompany: string
  retirementCategory: string
  semester: string
  selectedCourses: string[]
  studyPeriodStart: string | Dayjs
  studyPeriodEnd: string | Dayjs
  studentId: string
  agreementSigned: boolean
  familyAddress: string
  familyPhone: string
  emergencyContact: string
  emergencyPhone: string
  emergencyRelation: string
  applicationDate: string
  status: 'pending' | 'approved' | 'rejected'
  photo: string
  remarks: string
}

// Ë°®ÂçïÊï∞ÊçÆ
const formData = reactive<StudentFormData>({
  name: '',
  gender: 'Áî∑',
  birthDate: '',
  ethnicity: '',
  healthStatus: '',
  educationLevel: '',
  politicalStatus: '',
  phone: '',
  idNumber: '',
  idCardAddress: '',
  contactPhone: '',
  idCardFront: '',
  idCardBack: '',
  isRetired: false,
  insuranceCompany: '',
  retirementCategory: '',
  semester: '',
  selectedCourses: [],
  studyPeriodStart: '',
  studyPeriodEnd: '',
  studentId: '',
  agreementSigned: false,
  familyAddress: '',
  familyPhone: '',
  emergencyContact: '',
  emergencyPhone: '',
  emergencyRelation: '',
  applicationDate: '',
  status: 'approved', // Áõ¥Êé•ËÆæ‰∏∫Â∑≤ÈÄöËøá
  photo: '',
  remarks: ''
})

// ÊöÇÂ≠òÁÖßÁâáÊï∞ÊçÆ
const pendingPhotoData = ref({
  photo: '',
  idCardFront: '',
  idCardBack: ''
})
const fileList = ref<any[]>([])
const idCardFrontFileList = ref<any[]>([])
const idCardBackFileList = ref<any[]>([])
const previewVisible = ref<boolean>(false)
const previewImage = ref<string>('')
const previewTitle = ref<string>('')

// ÈÄâÈ°πÊï∞ÊçÆ
const ethnicityOptions = ref([
  { label: 'Ê±âÊóè', value: 'Ê±âÊóè' },
  { label: 'ËíôÂè§Êóè', value: 'ËíôÂè§Êóè' },
  { label: 'ÂõûÊóè', value: 'ÂõûÊóè' },
  { label: 'ËóèÊóè', value: 'ËóèÊóè' },
  { label: 'Áª¥ÂêæÂ∞îÊóè', value: 'Áª¥ÂêæÂ∞îÊóè' },
  { label: 'ËãóÊóè', value: 'ËãóÊóè' },
  { label: 'ÂΩùÊóè', value: 'ÂΩùÊóè' },
  { label: 'Â£ÆÊóè', value: 'Â£ÆÊóè' },
  { label: 'Â∏É‰æùÊóè', value: 'Â∏É‰æùÊóè' },
  { label: 'ÊúùÈ≤úÊóè', value: 'ÊúùÈ≤úÊóè' },
  { label: 'Êª°Êóè', value: 'Êª°Êóè' },
  { label: '‰æóÊóè', value: '‰æóÊóè' },
  { label: 'Áë∂Êóè', value: 'Áë∂Êóè' },
  { label: 'ÁôΩÊóè', value: 'ÁôΩÊóè' },
  { label: 'ÂúüÂÆ∂Êóè', value: 'ÂúüÂÆ∂Êóè' },
  { label: 'ÂìàÂ∞ºÊóè', value: 'ÂìàÂ∞ºÊóè' },
  { label: 'ÂìàËê®ÂÖãÊóè', value: 'ÂìàËê®ÂÖãÊóè' },
  { label: 'ÂÇ£Êóè', value: 'ÂÇ£Êóè' },
  { label: 'ÈªéÊóè', value: 'ÈªéÊóè' },
  { label: 'ÂÇàÂÉ≥Êóè', value: 'ÂÇàÂÉ≥Êóè' },
  { label: '‰Ω§Êóè', value: '‰Ω§Êóè' },
  { label: 'Áï≤Êóè', value: 'Áï≤Êóè' },
  { label: 'È´òÂ±±Êóè', value: 'È´òÂ±±Êóè' },
  { label: 'ÊãâÁ•úÊóè', value: 'ÊãâÁ•úÊóè' },
  { label: 'Ê∞¥Êóè', value: 'Ê∞¥Êóè' },
  { label: '‰∏ú‰π°Êóè', value: '‰∏ú‰π°Êóè' },
  { label: 'Á∫≥Ë•øÊóè', value: 'Á∫≥Ë•øÊóè' },
  { label: 'ÊôØÈ¢áÊóè', value: 'ÊôØÈ¢áÊóè' },
  { label: 'ÊüØÂ∞îÂÖãÂ≠úÊóè', value: 'ÊüØÂ∞îÂÖãÂ≠úÊóè' },
  { label: 'ÂúüÊóè', value: 'ÂúüÊóè' },
  { label: 'ËææÊñ°Â∞îÊóè', value: 'ËææÊñ°Â∞îÊóè' },
  { label: '‰ª´‰Ω¨Êóè', value: '‰ª´‰Ω¨Êóè' },
  { label: 'ÁæåÊóè', value: 'ÁæåÊóè' },
  { label: 'Â∏ÉÊúóÊóè', value: 'Â∏ÉÊúóÊóè' },
  { label: 'ÊííÊãâÊóè', value: 'ÊííÊãâÊóè' },
  { label: 'ÊØõÂçóÊóè', value: 'ÊØõÂçóÊóè' },
  { label: '‰ª°‰Ω¨Êóè', value: '‰ª°‰Ω¨Êóè' },
  { label: 'Èî°‰ºØÊóè', value: 'Èî°‰ºØÊóè' },
  { label: 'ÈòøÊòåÊóè', value: 'ÈòøÊòåÊóè' },
  { label: 'ÊôÆÁ±≥Êóè', value: 'ÊôÆÁ±≥Êóè' },
  { label: 'Â°îÂêâÂÖãÊóè', value: 'Â°îÂêâÂÖãÊóè' },
  { label: 'ÊÄíÊóè', value: 'ÊÄíÊóè' },
  { label: '‰πåÂ≠úÂà´ÂÖãÊóè', value: '‰πåÂ≠úÂà´ÂÖãÊóè' },
  { label: '‰øÑÁΩóÊñØÊóè', value: '‰øÑÁΩóÊñØÊóè' },
  { label: 'ÈÑÇÊ∏©ÂÖãÊóè', value: 'ÈÑÇÊ∏©ÂÖãÊóè' },
  { label: 'Âæ∑ÊòÇÊóè', value: 'Âæ∑ÊòÇÊóè' },
  { label: '‰øùÂÆâÊóè', value: '‰øùÂÆâÊóè' },
  { label: 'Ë£ïÂõ∫Êóè', value: 'Ë£ïÂõ∫Êóè' },
  { label: '‰∫¨Êóè', value: '‰∫¨Êóè' },
  { label: 'Â°îÂ°îÂ∞îÊóè', value: 'Â°îÂ°îÂ∞îÊóè' },
  { label: 'Áã¨ÈæôÊóè', value: 'Áã¨ÈæôÊóè' },
  { label: 'ÈÑÇ‰º¶Êò•Êóè', value: 'ÈÑÇ‰º¶Êò•Êóè' },
  { label: 'Ëµ´Âì≤Êóè', value: 'Ëµ´Âì≤Êóè' },
  { label: 'Èó®Â∑¥Êóè', value: 'Èó®Â∑¥Êóè' },
  { label: 'ÁèûÂ∑¥Êóè', value: 'ÁèûÂ∑¥Êóè' },
  { label: 'Âü∫ËØ∫Êóè', value: 'Âü∫ËØ∫Êóè' }
])

const educationOptions = ref([
  { label: 'Â∞èÂ≠¶', value: 'Â∞èÂ≠¶' },
  { label: 'Âàù‰∏≠', value: 'Âàù‰∏≠' },
  { label: 'È´ò‰∏≠', value: 'È´ò‰∏≠' },
  { label: '‰∏≠‰∏ì', value: '‰∏≠‰∏ì' },
  { label: 'Â§ß‰∏ì', value: 'Â§ß‰∏ì' },
  { label: 'Êú¨Áßë', value: 'Êú¨Áßë' },
  { label: 'Á°ïÂ£´Á†îÁ©∂Áîü', value: 'Á°ïÂ£´Á†îÁ©∂Áîü' },
  { label: 'ÂçöÂ£´Á†îÁ©∂Áîü', value: 'ÂçöÂ£´Á†îÁ©∂Áîü' }
])

const politicalStatusOptions = ref([
  { label: 'Áæ§‰ºó', value: 'Áæ§‰ºó' },
  { label: 'Âõ¢Âëò', value: 'Âõ¢Âëò' },
  { label: 'ÂÖöÂëò', value: 'ÂÖöÂëò' },
  { label: 'Ê∞ë‰∏ªÂÖöÊ¥æ', value: 'Ê∞ë‰∏ªÂÖöÊ¥æ' },
  { label: 'Êó†ÂÖöÊ¥æ‰∫∫Â£´', value: 'Êó†ÂÖöÊ¥æ‰∫∫Â£´' }
])

const healthOptions = ref([
  { label: 'ÂÅ•Â∫∑', value: 'ÂÅ•Â∫∑' },
  { label: 'ËâØÂ•Ω', value: 'ËâØÂ•Ω' },
  { label: '‰∏ÄËà¨', value: '‰∏ÄËà¨' },
  { label: 'ËæÉÂº±', value: 'ËæÉÂº±' },
  { label: 'ÊúâÊÖ¢ÊÄßÁóÖ', value: 'ÊúâÊÖ¢ÊÄßÁóÖ' }
])

const insuranceCompanyOptions = ref([
  { label: '‰∫∫‰øùË¥¢Èô©', value: '‰∫∫‰øùË¥¢Èô©' },
  { label: 'Â§™Âπ≥Ê¥ã‰øùÈô©', value: 'Â§™Âπ≥Ê¥ã‰øùÈô©' },
  { label: 'Âπ≥ÂÆâ‰øùÈô©', value: 'Âπ≥ÂÆâ‰øùÈô©' },
  { label: '‰∏≠ÂõΩ‰∫∫ÂØø', value: '‰∏≠ÂõΩ‰∫∫ÂØø' },
  { label: 'Êñ∞Âçé‰øùÈô©', value: 'Êñ∞Âçé‰øùÈô©' },
  { label: 'Ê≥∞Â∫∑‰øùÈô©', value: 'Ê≥∞Â∫∑‰øùÈô©' },
  { label: '‰∏≠ÈÇÆ‰øùÈô©', value: '‰∏≠ÈÇÆ‰øùÈô©' },
  { label: 'ÂÖ∂‰ªñ', value: 'ÂÖ∂‰ªñ' }
])

const retirementCategoryOptions = ref([
  { label: 'ÊÑèÂ§ñ‰øùÈô©', value: 'ÊÑèÂ§ñ‰øùÈô©' }
])

const semesterOptions = ref<Array<{ label: string; value: string }>>([])
const courseOptions = ref<Array<{ label: string; value: string }>>([])

// Ë°®ÂçïÈ™åËØÅËßÑÂàôÔºàÁÆÄÂåñÁâàÊú¨ÔºåÁßªÈô§Â§ßÈÉ®ÂàÜÈôêÂà∂Ôºâ
const formRules = {
  name: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ÂßìÂêç', trigger: 'blur' },
    { min: 2, max: 20, message: 'ÂßìÂêçÈïøÂ∫¶Âú®2-20‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  gender: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊÄßÂà´', trigger: 'change' }
  ],
  birthDate: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Âá∫ÁîüÊó•Êúü', trigger: 'change' }
  ],
  ethnicity: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Ê∞ëÊóè', trigger: 'change' }
  ],
  healthStatus: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÂÅ•Â∫∑Áä∂ÂÜµ', trigger: 'change' }
  ],
  educationLevel: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊñáÂåñÁ®ãÂ∫¶', trigger: 'change' }
  ],
  politicalStatus: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊîøÊ≤ªÈù¢Ë≤å', trigger: 'change' }
  ],
  idNumber: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑', trigger: 'blur' }
  ],
  isRetired: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊòØÂê¶Âú®ËÅå', trigger: 'change' }
  ],
  selectedCourses: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Ëá≥Â∞ë‰∏ÄÈó®ËØæÁ®ã', trigger: 'change' }
  ],
  agreementSigned: [
    { required: true, message: 'ËØ∑ÈÄâÊã©ÊòØÂê¶Á≠æËÆ¢Ë∂ÖÈæÑÂçèËÆÆ', trigger: 'change' }
  ],
  familyAddress: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Áé∞Â±Ö‰ΩèÂú∞ÂùÄ', trigger: 'blur' }
  ],
  emergencyContact: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ª‰∫∫', trigger: 'blur' }
  ],
  emergencyPhone: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Á¥ßÊÄ•ËÅîÁ≥ªÁîµËØù', trigger: 'blur' }
  ],
  idCardAddress: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂú∞ÂùÄ', trigger: 'blur' }
  ],
  contactPhone: [
    { required: true, message: 'ËØ∑ËæìÂÖ•ËÅîÁ≥ªÁîµËØù', trigger: 'blur' }
  ],
  semester: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Â≠¶Êúü', trigger: 'change' }
  ]
}

// ËÆ°ÁÆóÂ±ûÊÄß
const idCardFrontUrl = computed(() => {
  const frontSource = pendingPhotoData.value.idCardFront || formData.idCardFront
  if (!frontSource) return ''
  
  if (frontSource.startsWith('data:') || frontSource.startsWith('http')) {
    return frontSource
  }
  
  const { protocol, host } = window.location
  return `${protocol}//${host}${frontSource.startsWith('/') ? '' : '/'}${frontSource}`
})

const idCardBackUrl = computed(() => {
  const backSource = pendingPhotoData.value.idCardBack || formData.idCardBack
  if (!backSource) return ''
  
  if (backSource.startsWith('data:') || backSource.startsWith('http')) {
    return backSource
  }
  
  const { protocol, host } = window.location
  return `${protocol}//${host}${backSource.startsWith('/') ? '' : '/'}${backSource}`
})

const photoUrl = computed(() => {
  const photoSource = pendingPhotoData.value.photo || formData.photo
  if (!photoSource) return ''
  
  if (photoSource.startsWith('data:') || photoSource.startsWith('http')) {
    return photoSource
  }
  
  const { protocol, host } = window.location
  return `${protocol}//${host}${photoSource.startsWith('/') ? '' : '/'}${photoSource}`
})

// Â§ÑÁêÜ‰øùÈô©ÂºÄÂßãÊó•ÊúüÂèòÂåñÔºåËá™Âä®ËÆæÁΩÆÁªìÊùüÊó•Êúü
const handleInsuranceStartDateChange = (date: Dayjs | null): void => {
  if (date) {
    formData.studyPeriodEnd = date.add(1, 'year')
    message.success('Â∑≤Ëá™Âä®ËÆæÁΩÆ‰øùÈô©ÁªìÊùüÊó•Êúü‰∏∫1Âπ¥Âêé')
  } else {
    formData.studyPeriodEnd = ''
  }
}

// Â§ÑÁêÜË∫´‰ªΩËØÅËØªÂç°Âô®Êï∞ÊçÆËØªÂèñ
const handleIdCardDataRead = async (idCardData: IdCardData): Promise<void> => {
  formData.name = idCardData.name || ''
  
  if (idCardData.sex) {
    const genderMap: Record<string, string> = {
      '1': 'Áî∑', 'Áî∑': 'Áî∑', 'M': 'Áî∑', 'MALE': 'Áî∑',
      '2': 'Â•≥', 'Â•≥': 'Â•≥', 'F': 'Â•≥', 'FEMALE': 'Â•≥'
    }
    formData.gender = genderMap[idCardData.sex.toUpperCase()] || 'Áî∑'
  }
  
  formData.idNumber = idCardData.cardno || ''
  formData.idCardAddress = idCardData.address || ''
  formData.ethnicity = idCardData.folk || ''
  
  // Âá∫ÁîüÊó•ÊúüÂ§ÑÁêÜ - ‰ºòÂÖà‰ΩøÁî®Ë∫´‰ªΩËØÅÂè∑Á†ÅÊèêÂèñÔºåÂÖ∂Ê¨°‰ΩøÁî®ËØªÂç°Âô®Êï∞ÊçÆ
  if (formData.idNumber) {
    const extractedBirthDate = extractBirthDateFromId(formData.idNumber)
    if (extractedBirthDate) {
      formData.birthDate = extractedBirthDate
      console.log('‚úÖ ‰ªéË∫´‰ªΩËØÅÂè∑Á†ÅÊèêÂèñÂá∫ÁîüÊó•Êúü:', extractedBirthDate.format('YYYY-MM-DD'))
    }
  } else if (idCardData.born) {
    try {
      const birthYear = idCardData.born.substring(0, 4)
      const birthMonth = idCardData.born.substring(4, 6)
      const birthDay = idCardData.born.substring(6, 8)
      formData.birthDate = dayjs(`${birthYear}-${birthMonth}-${birthDay}`)
      console.log('‚úÖ ‰ªéËØªÂç°Âô®Êï∞ÊçÆËé∑ÂèñÂá∫ÁîüÊó•Êúü:', `${birthYear}-${birthMonth}-${birthDay}`)
    } catch (error) {
      console.error('Ëß£ÊûêÂá∫ÁîüÊó•ÊúüÂ§±Ë¥•:', error)
    }
  }
  
  // Ë∫´‰ªΩËØÅÁÖßÁâá
  if (idCardData.imageFront) {
    pendingPhotoData.value.idCardFront = `data:image/jpeg;base64,${idCardData.imageFront}`
  }
  
  if (idCardData.imageBack) {
    pendingPhotoData.value.idCardBack = `data:image/jpeg;base64,${idCardData.imageBack}`
  }
  
  if (pendingPhotoData.value.photo || pendingPhotoData.value.idCardFront || pendingPhotoData.value.idCardBack) {
    message.info('Ë∫´‰ªΩËØÅÁÖßÁâáÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåÂ∞ÜÂú®Êèê‰∫§Ë°®ÂçïÊó∂Áªü‰∏Ä‰∏ä‰º†')
  }
}

// Â§ÑÁêÜËØªÂç°Âô®ÈîôËØØ
const handleReaderError = (error: string): void => {
  message.error(`ËØªÂç°Âô®ÈîôËØØ: ${error}`)
}

// Â§ÑÁêÜÁÖßÁâá‰∏ä‰º†
const handlePhotoUpload = async (file: File): Promise<boolean> => {
  try {
    const reader = new FileReader()
    reader.onload = (e) => {
      pendingPhotoData.value.photo = e.target?.result as string
      message.success('ÁÖßÁâáÊöÇÂ≠òÊàêÂäüÔºåÂ∞ÜÂú®Êèê‰∫§Êó∂‰∏ä‰º†')
    }
    reader.readAsDataURL(file)
    return false
  } catch (error) {
    message.error('ÁÖßÁâáËØªÂèñÂ§±Ë¥•')
    return false
  }
}

// Â§ÑÁêÜË∫´‰ªΩËØÅÁÖßÁâá‰∏ä‰º†
const handleIdCardUpload = async (file: File, type: 'front' | 'back'): Promise<boolean> => {
  try {
    const formData = new FormData()
    formData.append('image', file)
    
    const uploadingMessage = message.loading(
      `Ê≠£Âú®‰∏ä‰º†${type === 'front' ? 'Ë∫´‰ªΩËØÅÊ≠£Èù¢' : 'Ë∫´‰ªΩËØÅÂèçÈù¢'}...`, 
      0
    )

    const response = await ApplicationService.uploadImage(formData)
    uploadingMessage()
    
    if (response.code === 200) {
      if (type === 'front') {
        formData.idCardFront = response.data.url
      } else {
        formData.idCardBack = response.data.url
      }
      
      message.success(`Ë∫´‰ªΩËØÅ${type === 'front' ? 'Ê≠£Èù¢' : 'ÂèçÈù¢'}‰∏ä‰º†ÊàêÂäü`)
    } else {
      message.error(response.message || '‰∏ä‰º†Â§±Ë¥•')
    }
    
    return false
  } catch (error) {
    message.error('‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
    return false
  }
}

// È¢ÑËßàË∫´‰ªΩËØÅÁÖßÁâá
const previewIdCard = (type: 'front' | 'back'): void => {
  if (type === 'front' && (formData.idCardFront || pendingPhotoData.value.idCardFront)) {
    previewImage.value = idCardFrontUrl.value
    previewTitle.value = 'Ë∫´‰ªΩËØÅÊ≠£Èù¢'
    previewVisible.value = true
  } else if (type === 'back' && (formData.idCardBack || pendingPhotoData.value.idCardBack)) {
    previewImage.value = idCardBackUrl.value
    previewTitle.value = 'Ë∫´‰ªΩËØÅÂèçÈù¢'
    previewVisible.value = true
  }
}

// ÂÖ≥Èó≠È¢ÑËßà
const handlePreviewCancel = (): void => {
  previewVisible.value = false
  previewImage.value = ''
  previewTitle.value = ''
}

// Ê∏ÖÈô§Ë∫´‰ªΩËØÅÁÖßÁâá
const clearIdCardPhoto = (type: 'front' | 'back'): void => {
  if (type === 'front') {
    formData.idCardFront = ''
    idCardFrontFileList.value = []
    message.success('Ë∫´‰ªΩËØÅÊ≠£Èù¢ÁÖßÁâáÂ∑≤Ê∏ÖÈô§')
  } else if (type === 'back') {
    formData.idCardBack = ''
    idCardBackFileList.value = []
    message.success('Ë∫´‰ªΩËØÅÂèçÈù¢ÁÖßÁâáÂ∑≤Ê∏ÖÈô§')
  }
}

// ‰∏ä‰º†ÊöÇÂ≠òÁöÑÁÖßÁâá
const uploadPendingPhotos = async (): Promise<void> => {
  const uploadBase64Image = async (base64Data: string, type: string): Promise<string | null> => {
    try {
      const response = await fetch(base64Data)
      const blob = await response.blob()
      const file = new File([blob], `${type}_${Date.now()}.jpg`, { type: 'image/jpeg' })
      
      const formData = new FormData()
      formData.append('image', file)
      
      const uploadResponse = await ApplicationService.uploadImage(formData)
      return uploadResponse.code === 200 ? uploadResponse.data.url : null
    } catch (error) {
      console.error(`‰∏ä‰º†${type}Â§±Ë¥•:`, error)
      return null
    }
  }

  // ‰∏ä‰º†‰∏™‰∫∫ÁÖßÁâá
  if (pendingPhotoData.value.photo && pendingPhotoData.value.photo.startsWith('data:')) {
    const photoUrl = await uploadBase64Image(pendingPhotoData.value.photo, 'photo')
    if (photoUrl) {
      formData.photo = photoUrl
    }
  }
  
  // ‰∏ä‰º†Ë∫´‰ªΩËØÅÊ≠£Èù¢
  if (pendingPhotoData.value.idCardFront && pendingPhotoData.value.idCardFront.startsWith('data:')) {
    const frontUrl = await uploadBase64Image(pendingPhotoData.value.idCardFront, 'front')
    if (frontUrl) {
      formData.idCardFront = frontUrl
    }
  }
  
  // ‰∏ä‰º†Ë∫´‰ªΩËØÅÂèçÈù¢
  if (pendingPhotoData.value.idCardBack && pendingPhotoData.value.idCardBack.startsWith('data:')) {
    const backUrl = await uploadBase64Image(pendingPhotoData.value.idCardBack, 'back')
    if (backUrl) {
      formData.idCardBack = backUrl
    }
  }
}

// Â§ÑÁêÜË°®ÂçïÊèê‰∫§
const handleSubmit = async (): Promise<void> => {
  try {
    await formRef.value.validate()
    
    submitting.value = true
    
    // ÂÖà‰∏ä‰º†ÊöÇÂ≠òÁöÑÁÖßÁâá
    await uploadPendingPhotos()

    // ËΩ¨Êç¢Êó•ÊúüÊ†ºÂºè
    const submitData = {
      ...formData,
      birthDate: formData.birthDate ? dayjs(formData.birthDate).format('YYYY-MM-DD') : '',
      studyPeriodStart: formData.studyPeriodStart ? dayjs(formData.studyPeriodStart).format('YYYY-MM-DD') : '',
      studyPeriodEnd: formData.studyPeriodEnd ? dayjs(formData.studyPeriodEnd).format('YYYY-MM-DD') : '',
      applicationDate: new Date().toISOString(),
      status: 'approved' // Áõ¥Êé•ËÆæ‰∏∫Â∑≤ÈÄöËøá
    }

    // Áõ¥Êé•Ë∞ÉÁî®Â≠¶ÁîüÊ∑ªÂä†Êé•Âè£
    const response = await StudentService.createStudent(submitData)
    
    if (response.code === 200 || response.code === 201) {
      message.success('Â≠¶ÁîüÊ∑ªÂä†ÊàêÂäüÔºÅ')
      handleReset()
      modalVisible.value = false
      emit('success')
    } else {
      message.error(response.message || 'Â≠¶ÁîüÊ∑ªÂä†Â§±Ë¥•')
    }
  } catch (error: any) {
    console.error('Ê∑ªÂä†Â≠¶ÁîüÂ§±Ë¥•:', error)
    
    let errorMessage = 'Â≠¶ÁîüÊ∑ªÂä†Â§±Ë¥•ÔºåËØ∑ÈáçËØï'
    
    if (error.response && error.response.data) {
      const errorData = error.response.data
      if (errorData.message) {
        errorMessage = errorData.message
      }
    } else if (error.message) {
      errorMessage = error.message
    }
    
    message.error(errorMessage)
  } finally {
    submitting.value = false
  }
}

// Â§ÑÁêÜË°®ÂçïÊèê‰∫§Â§±Ë¥•
const handleSubmitFailed = (errorInfo: any): void => {
  console.error('Ë°®ÂçïÈ™åËØÅÂ§±Ë¥•:', errorInfo)
  message.error('ËØ∑Ê£ÄÊü•Ë°®ÂçïÂ°´ÂÜôÊòØÂê¶ÂÆåÊï¥')
}

// ÈáçÁΩÆË°®Âçï
const handleReset = (): void => {
  formRef.value?.resetFields()
  
  // ÈáçÁΩÆË°®ÂçïÊï∞ÊçÆ
  Object.assign(formData, {
    name: '',
    gender: 'Áî∑',
    birthDate: '',
    ethnicity: '',
    healthStatus: '',
    educationLevel: '',
    politicalStatus: '',
    phone: '',
    idNumber: '',
    idCardAddress: '',
    contactPhone: '',
    idCardFront: '',
    idCardBack: '',
    isRetired: false,
    insuranceCompany: '',
    retirementCategory: '',
    semester: '',
    selectedCourses: [],
    studyPeriodStart: '',
    studyPeriodEnd: '',
    studentId: '',
    agreementSigned: false,
    familyAddress: '',
    familyPhone: '',
    emergencyContact: '',
    emergencyPhone: '',
    emergencyRelation: '',
    applicationDate: '',
    status: 'approved' as const,
    photo: '',
    remarks: ''
  })
  
  // Ê∏ÖÈô§Êñá‰ª∂‰∏ä‰º†ÂàóË°®
  idCardFrontFileList.value = []
  idCardBackFileList.value = []
  fileList.value = []
  
  // Ê∏ÖÈô§ÊöÇÂ≠òÁÖßÁâáÊï∞ÊçÆ
  pendingPhotoData.value = {
    photo: '',
    idCardFront: '',
    idCardBack: ''
  }
  
  // ÈáçÁΩÆÂÖ∂‰ªñÁä∂ÊÄÅ
  submitting.value = false
  previewVisible.value = false
  previewImage.value = ''
  previewTitle.value = ''
}

/**
 * ‰ªéË∫´‰ªΩËØÅÂè∑Á†Å‰∏≠ÊèêÂèñÂá∫ÁîüÊó•Êúü
 * @param idNumber Ë∫´‰ªΩËØÅÂè∑Á†Å
 * @returns DayjsÂØπË±°Êàñnull
 */
const extractBirthDateFromId = (idNumber: string): Dayjs | null => {
  if (!idNumber) return null
  
  try {
    if (idNumber.length === 18) {
      // 18‰ΩçË∫´‰ªΩËØÅÔºöÁ¨¨7-14‰ΩçÊòØÂá∫ÁîüÊó•Êúü YYYYMMDD
      const birthStr = idNumber.substring(6, 14)
      if (birthStr.length === 8) {
        const year = parseInt(birthStr.substring(0, 4))
        const month = parseInt(birthStr.substring(4, 6))
        const day = parseInt(birthStr.substring(6, 8))
        
        // È™åËØÅÊó•ÊúüÁöÑÂêàÁêÜÊÄß
        if (year >= 1900 && year <= new Date().getFullYear() && 
            month >= 1 && month <= 12 && 
            day >= 1 && day <= 31) {
          const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`
          return dayjs(dateStr)
        }
      }
    } else if (idNumber.length === 15) {
      // 15‰ΩçË∫´‰ªΩËØÅÔºöÁ¨¨7-12‰ΩçÊòØÂá∫ÁîüÊó•Êúü YYMMDD
      const birthStr = idNumber.substring(6, 12)
      if (birthStr.length === 6) {
        let year = parseInt(birthStr.substring(0, 2))
        const month = parseInt(birthStr.substring(2, 4))
        const day = parseInt(birthStr.substring(4, 6))
        
        // 15‰ΩçË∫´‰ªΩËØÅÁöÑÂπ¥‰ªΩÂà§Êñ≠Ôºö00-09‰∏∫2000-2009Ôºå10-99‰∏∫1910-1999
        year = year <= 9 ? 2000 + year : 1900 + year
        
        // È™åËØÅÊó•ÊúüÁöÑÂêàÁêÜÊÄß
        if (year >= 1900 && year <= new Date().getFullYear() && 
            month >= 1 && month <= 12 && 
            day >= 1 && day <= 31) {
          const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`
          return dayjs(dateStr)
        }
      }
    }
  } catch (error) {
    console.error('Ëß£ÊûêË∫´‰ªΩËØÅÂá∫ÁîüÊó•ÊúüÂ§±Ë¥•:', error)
  }
  
  return null
}

/**
 * Â§ÑÁêÜË∫´‰ªΩËØÅÂè∑Á†ÅËæìÂÖ•
 */
const handleIdNumberInput = (): void => {
  // ÂΩìË∫´‰ªΩËØÅÂè∑Á†ÅÈïøÂ∫¶Ë∂≥Â§üÊó∂ÔºåËá™Âä®ÊèêÂèñÂá∫ÁîüÊó•Êúü
  if (formData.idNumber && (formData.idNumber.length === 15 || formData.idNumber.length === 18)) {
    const birthDate = extractBirthDateFromId(formData.idNumber)
    if (birthDate) {
      formData.birthDate = birthDate
      console.log('üéâ Â∑≤‰ªéË∫´‰ªΩËØÅÂè∑Á†ÅËá™Âä®ÊèêÂèñÂá∫ÁîüÊó•Êúü:', birthDate.format('YYYY-MM-DD'))
    } else {
      console.warn('‚ö†Ô∏è Ë∫´‰ªΩËØÅÂè∑Á†Å‰∏≠ÁöÑÂá∫ÁîüÊó•ÊúüÊ†ºÂºè‰∏çÊ≠£Á°Æ')
    }
  }
}

// ÂèñÊ∂àÊìç‰Ωú
const handleCancel = (): void => {
  modalVisible.value = false
}

// Ëé∑ÂèñÂ≠¶ÊúüÂàóË°®
const fetchSemesters = async (): Promise<void> => {
  try {
    semestersLoading.value = true
    const response = await CourseService.getSemesters()
    semesterOptions.value = response.data?.map((semester: string) => ({
      label: semester,
      value: semester
    })) || []
    
    // ËÆæÁΩÆÈªòËÆ§Â≠¶Êúü
    if (semesterOptions.value.length > 0) {
      const currentYear = new Date().getFullYear()
      const currentSemester = `${currentYear}Âπ¥ÁßãÂ≠£`
      const defaultSemester = semesterOptions.value.find(s => s.value === currentSemester)
      if (defaultSemester) {
        formData.semester = defaultSemester.value
      } else {
        formData.semester = semesterOptions.value[0].value
      }
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂ≠¶ÊúüÂàóË°®Â§±Ë¥•:', error)
  } finally {
    semestersLoading.value = false
  }
}

// Ëé∑ÂèñËØæÁ®ãÂàóË°®
const fetchCourses = async (): Promise<void> => {
  try {
    coursesLoading.value = true
    const response = await CourseService.getCourses({
      page: 1,
      pageSize: 100,
      status: 'PUBLISHED'
    })
    courseOptions.value = (response.data?.list || []).map((course: any) => ({
      label: course.name,
      value: course.id
    }))
  } catch (error) {
    console.error('Ëé∑ÂèñËØæÁ®ãÂàóË°®Â§±Ë¥•:', error)
  } finally {
    coursesLoading.value = false
  }
}

// ÁõëÂê¨ÂºπÁ™óÊâìÂºÄÁä∂ÊÄÅ
watch(modalVisible, (newValue) => {
  if (newValue) {
    // ÂºπÁ™óÊâìÂºÄÊó∂Ëé∑ÂèñÊï∞ÊçÆ
    fetchSemesters()
    fetchCourses()
  } else {
    // ÂºπÁ™óÂÖ≥Èó≠Êó∂ÈáçÁΩÆË°®Âçï
    handleReset()
  }
})
</script>

<style scoped>
.student-add-modal .ant-modal-body {
  max-height: 80vh;
  overflow-y: auto;
}

/* ‰∏ä‰º†ÁªÑ‰ª∂Ê†∑Âºè */
.id-card-uploader, .avatar-uploader {
  width: 100%;
}

.id-card-upload-area, .upload-area {
  border: 2px dashed #d9d9d9;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.3s ease;
  min-height: 150px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.id-card-upload-area:hover, .upload-area:hover {
  border-color: #40a9ff;
}

.id-card-image, .uploaded-image {
  max-width: 100%;
  max-height: 200px;
  border-radius: 4px;
  object-fit: cover;
}

.upload-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #666;
}

.preview-image-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.preview-image {
  max-width: 100%;
  max-height: 500px;
  object-fit: contain;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .student-add-modal .ant-modal {
    width: 95% !important;
    margin: 10px auto;
  }
}
</style>
