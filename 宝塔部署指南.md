# 🚀 LNDX系统 - 腾讯云宝塔面板部署指南

## 📋 部署概览

本项目专为**腾讯云宝塔面板**用户设计，提供完整的一键部署方案。

### 系统架构
```
用户访问 → 宝塔Nginx → PM2集群 → PostgreSQL/MySQL
             ↓           ↓
       Vue3前端静态文件   Node.js后端API
```

## 🛠️ 环境要求

### 服务器配置
- **CPU**: 2核心+ (推荐4核心)
- **内存**: 4GB+ (推荐8GB)
- **磁盘**: 20GB+ SSD
- **系统**: CentOS 7+ / Ubuntu 18.04+

### 宝塔面板要求
- **宝塔版本**: 7.7.0+
- **必需软件**: Node.js 18.x, PostgreSQL 12+/MySQL 8.0+, PM2管理器

## 📦 需要上传的文件

### 1. 项目源码 (整个项目文件夹)
```
lndx/
├── backend/           # 后端源码 (需要编译)
├── frontend/         # 前端源码 (需要编译) 
├── baota-deploy.sh   # 宝塔部署脚本
└── 宝塔部署指南.md    # 本文档
```

### 2. 上传位置
- **推荐路径**: `/www/wwwroot/lndx`
- **通过**: 宝塔文件管理器上传压缩包或Git克隆

## 🎯 部署步骤

### 第一步：宝塔面板准备

#### 1.1 安装必要软件
登录宝塔面板 → **软件商店**，安装：
- ✅ **Node.js版本管理器** (免费)
- ✅ **PM2管理器** (免费) 
- ✅ **PostgreSQL** (免费，推荐) 或 **MySQL**
- ✅ **Nginx** (通常预装)

#### 1.2 配置Node.js环境
1. 打开 **Node.js版本管理器**
2. 安装 **Node.js 18.x** 版本
3. 设置为默认版本
4. 安装全局包：`npm install -g pnpm`

#### 1.3 创建数据库
**PostgreSQL方式 (推荐):**
1. 打开 **数据库** → **PostgreSQL**
2. 创建数据库: `lndx_production`，编码: `UTF8`
3. **使用超级用户 `postgres`** (避免权限问题)
4. 记录 `postgres` 用户的密码

**MySQL方式:**
1. 打开 **数据库** → **MySQL**
2. 创建数据库: `lndx_production`，编码: `utf8mb4_unicode_ci`
3. **使用 `root` 用户** (避免权限问题)
4. 记录 `root` 用户的密码

### 第二步：上传项目文件

#### 2.1 方法一：Git克隆 (推荐)
```bash
# SSH连接服务器
cd /www/wwwroot
git clone https://your-repo-url.git lndx
```

#### 2.2 方法二：文件管理器上传
1. 压缩本地项目文件夹为 `lndx.zip`
2. 使用宝塔 **文件管理器** 上传到 `/www/wwwroot/`
3. 解压并确保文件夹名为 `lndx`

### 第三步：自动化部署

#### 3.1 运行部署脚本
```bash
# SSH连接服务器
cd /www/wwwroot/lndx
chmod +x baota-deploy.sh

# 一键部署 (需要提供域名和postgres密码)
./baota-deploy.sh --domain ln.tuojiayi.com --db-pass your-postgres-password
```

#### 3.2 脚本自动完成的任务
- ✅ 配置环境变量 (`.env`文件)
- ✅ 安装前后端依赖 (`pnpm install`)
- ✅ **编译后端** (`pnpm build` → `dist/`文件夹)
- ✅ **编译前端** (`pnpm build` → `dist/`文件夹)
- ✅ 数据库初始化和数据填充
- ✅ 配置Nginx反向代理
- ✅ 启动PM2进程管理

### 第四步：网站配置

#### 4.1 创建网站
1. 宝塔面板 → **网站** → **添加站点**
2. **域名**: 填入你的域名 (如：`example.com`)
3. **根目录**: `/www/wwwroot/lndx/frontend/dist`
4. **PHP版本**: 纯静态
5. **创建数据库**: 否 (已手动创建)

#### 4.2 SSL证书 (推荐)
1. 站点设置 → **SSL**
2. **Let's Encrypt**: 申请免费证书
3. **强制HTTPS**: 开启

## ✅ 验证部署

### 检查服务状态
1. **PM2管理器**: 查看 `lndx-backend` 进程状态
2. **访问测试**: 
   - 前端：`https://your-domain.com`
   - 后端API：`https://your-domain.com/api/health`
3. **日志检查**: 宝塔面板查看网站访问日志

### 默认登录账户
- 👑 **超级管理员**: `13800000000` / `password123`
- 👨‍🏫 **教师**: `13800000001` / `password123`  
- 👨‍🎓 **学生**: `13800000002` / `password123`

⚠️ **首次登录后必须修改密码！**

## 🔧 编译说明

### 后端编译 (TypeScript → JavaScript)
- **编译命令**: `pnpm build`
- **输出目录**: `backend/dist/`
- **入口文件**: `backend/dist/index.js`
- **是否必需**: ✅ **必须编译** (TypeScript不能直接运行)

### 前端编译 (Vue3 → 静态文件)
- **编译命令**: `pnpm build`
- **输出目录**: `frontend/dist/`
- **文件类型**: HTML, CSS, JS静态文件
- **是否必需**: ✅ **必须编译** (生产环境使用静态文件)

### 编译后的文件结构
```
lndx/
├── backend/
│   ├── src/           # 源码 (上传但不运行)
│   ├── dist/          # 编译产物 (PM2运行这个)
│   ├── node_modules/  # 依赖 (部署时安装)
│   ├── .env           # 环境变量 (部署时创建)
│   └── package.json
├── frontend/
│   ├── src/           # 源码 (上传但不使用)  
│   ├── dist/          # 编译产物 (Nginx服务这个)
│   ├── node_modules/  # 依赖 (部署时安装)
│   └── package.json
```

## 🛡️ 安全配置

### 宝塔面板安全
1. **修改面板端口** (默认8888)
2. **绑定安全域名**
3. **开启面板SSL**
4. **设置IP白名单**

### 防火墙配置
**开放端口**:
- `80` (HTTP) 
- `443` (HTTPS)
- `22` (SSH)
- `8888` (宝塔面板端口)

**禁止端口**:
- `3000` (Node.js后端，只允许本地访问)
- `5432` (PostgreSQL)
- `3306` (MySQL)

## 📊 监控和维护

### 宝塔面板管理
- **网站监控**: 宝塔面板 → 网站 → 监控
- **PM2管理**: 宝塔面板 → PM2管理器
- **数据库监控**: 宝塔面板 → 数据库 → 性能监控
- **系统监控**: 宝塔面板 → 监控

### 常用管理命令
```bash
# 查看PM2状态
pm2 status

# 查看应用日志  
pm2 logs lndx-backend

# 重启应用
pm2 restart lndx-backend

# 查看系统状态
htop
df -h
```

## 🔄 更新部署

### 代码更新流程
```bash
cd /www/wwwroot/lndx

# 更新代码
git pull

# 重新编译和部署
./baota-deploy.sh --update --domain your-domain.com
```

### 宝塔面板操作
1. **停止应用**: PM2管理器 → 停止 `lndx-backend`
2. **更新文件**: 文件管理器上传新版本
3. **启动应用**: PM2管理器 → 启动 `lndx-backend`

## 🚨 故障排查

### 常见问题及解决

#### 1. 网站无法访问
- 检查Nginx配置：宝塔面板 → 网站 → 配置文件
- 检查SSL证书：宝塔面板 → 网站 → SSL
- 查看访问日志：宝塔面板 → 网站 → 日志

#### 2. API接口报错
- 检查PM2状态：PM2管理器 → 查看 `lndx-backend`
- 查看应用日志：`pm2 logs lndx-backend`
- 检查数据库连接：宝塔面板 → 数据库 → 连接测试

#### 3. 编译失败
- 检查Node.js版本：必须是18.x
- 检查依赖安装：`cd backend && pnpm install`
- 查看编译错误：`cd backend && pnpm build`

#### 4. 数据库权限问题
- **问题**: `ERROR: permission denied for schema public`
- **原因**: 普通用户对 public schema 没有权限
- **解决**: 使用 `postgres` 超级用户 (脚本已自动配置)
- **检查**: 确认 `--db-pass` 是 postgres 用户的密码

## 📞 技术支持

### 常用检查命令
```bash
# 检查服务状态
systemctl status nginx
systemctl status postgresql  # 或 mysql

# 检查端口占用
netstat -tlnp | grep :3000
netstat -tlnp | grep :80

# 检查磁盘空间
df -h

# 查看系统负载
top
```

### 日志位置
- **应用日志**: `/www/wwwroot/lndx/backend/logs/`
- **PM2日志**: `~/.pm2/logs/`
- **Nginx日志**: 宝塔面板 → 网站 → 日志
- **系统日志**: 宝塔面板 → 日志

---

## 🎉 部署成功！

完成以上步骤后，您的LNDX学生报名管理系统就成功部署在腾讯云宝塔面板上了！

**访问地址**: `https://your-domain.com`

**祝您使用愉快！** 🚀
